<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Nova Licitação</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
<style>
:root{
  --bg:#f4f6fa; --azul:#0b1e39; --azul2:#193055; --dourado:#c9a86c;
  --card:#fff; --muted:#64748b; --ok:#16a34a; --danger:#dc2626; --warn:#b45309;
  --shadow:0 10px 28px rgba(0,0,0,.10); --radius:14px;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',sans-serif;}
body{background:var(--bg);padding:26px;color:#0f172a;}

.box{
  background:#fff;max-width:900px;margin:auto;border-radius:16px;
  padding:24px;box-shadow:var(--shadow);
}

.title{
  font-size:22px;font-weight:700;color:var(--azul);margin-bottom:18px;
}

.field{margin-bottom:12px;}
label{font-size:12px;font-weight:700;color:#334155;margin-bottom:4px;display:block;}
input,select{
  width:100%;padding:12px;border:1px solid #d0d4da;border-radius:12px;
  background:#fff;font-size:14px;text-transform:uppercase;
}

.row{display:flex;gap:12px;flex-wrap:wrap;}

.btn{
  border:none;padding:12px 18px;font-weight:700;border-radius:12px;
  cursor:pointer;font-size:14px;
}
.btn-primary{background:var(--azul);color:#fff;}
.btn-primary:hover{background:var(--azul2);}
.btn-lite{background:#fff;border:1px solid #d0d4da;}
.btn-close{background:#e2e8f0;color:#222;}
.help{font-size:11px;color:#64748b;margin-top:4px;}

.toast{
  position:fixed;right:16px;bottom:16px;background:#fff;border-left:6px solid var(--danger);
  padding:12px 14px;border-radius:10px;box-shadow:var(--shadow);z-index:9999;
}
.toast.ok{border-left-color:var(--ok);}
.toast b{display:block;}
.toast small{color:#64748b;}
</style>
</head>
<body>

<div class="box">
  <div class="title">Nova Licitação</div>

  <div class="row">
    <div class="field" style="flex:1">
      <label>INSTITUIÇÃO</label>
      <div style="display:flex;gap:10px;align-items:center">
        <select id="selInstituicao" style="flex:1"></select>
        <button class="btn btn-lite" onclick="abrirCadastroEmpresa()">+</button>
      </div>
      <div class="help">Clique no "+" para cadastrar nova empresa.</div>
    </div>

    <div class="field" style="width:180px">
      <label>DATA DA SESSÃO</label>
      <input id="inpData" placeholder="DD/MM/AAAA" data-mask="date" />
    </div>

    <div class="field" style="width:180px">
      <label>VALOR TOTAL</label>
      <input id="inpValor" placeholder="R$ 0,00" data-mask="money" />
    </div>
  </div>

  <div class="row">
    <div class="field" style="flex:1">
      <label>CRITÉRIO DE JULGAMENTO</label>
      <input id="inpCriterio" placeholder="MAIOR DESCONTO POR ITEM" />
    </div>
    <div class="field" style="flex:1">
      <label>MODO DE DISPUTA</label>
      <input id="inpModo" placeholder="ABERTO E FECHADO" />
    </div>
  </div>

  <div class="row">
    <div class="field" style="flex:1">
      <label>STATUS</label>
      <select id="selStatus">
        <option>Pendente</option>
        <option>Futura</option>
        <option>Em andamento</option>
        <option>Finalizada</option>
        <option>Suspensa</option>
      </select>
    </div>
  </div>

  <div class="row" style="margin-top:20px;justify-content:flex-end;gap:10px">
    <button class="btn btn-close" onclick="window.close()">Fechar</button>
    <button class="btn btn-primary" onclick="salvar()">Salvar Licitação</button>
  </div>

</div>

<script>
/* ==========================
     CONFIG
========================== */
const DEFAULT_API = "https://script.google.com/macros/s/AKfycbxdsMCq_MupdCiIz_-mEiuAFUiotFz7wPUTVgDUeNsbdei3zvBUPonf5aB0NnBBxoUR6g/exec";
const API = DEFAULT_API;

/* ==========================
    TOAST
========================== */
function toast(t,d='',ok=false){
  const el = document.createElement('div');
  el.className = 'toast' + (ok?' ok':'');
  el.innerHTML = `<b>${t}</b>${d?`<small>${d}</small>`:''}`;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),4000);
}

/* ==========================
    MASKS
========================== */
function maskMoney(el){
  let v=el.value.replace(/[^\d,]/g,'').replace(',', '');
  if(!v){el.value='';return;}
  v = (parseInt(v,10)||0).toString();
  if(v.length<3) v=v.padStart(3,'0');
  const c=v.slice(-2), i=v.slice(0,-2);
  el.value='R$ '+i.replace(/\B(?=(\d{3})+(?!\d))/g,'.')+','+c;
}
function maskDate(el){
  let v=el.value.replace(/\D/g,'').slice(0,8);
  if(v.length>=5) el.value=v.slice(0,2)+'/'+v.slice(2,4)+'/'+v.slice(4);
  else if(v.length>=3) el.value=v.slice(0,2)+'/'+v.slice(2);
  else el.value=v;
}
document.querySelectorAll('input[data-mask="money"]').forEach(el=>{
  el.addEventListener('input',()=>{ if(!el.value.startsWith('R$ ')) maskMoney(el); });
});
document.querySelectorAll('input[data-mask="date"]').forEach(el=>{
  el.addEventListener('input',()=>maskDate(el));
});

/* ==========================
    LOAD EMPRESAS
========================== */
async function carregarEmpresas(){
  try{
    const r = await fetch(API+'?action=listEmpresas');
    const j = await r.json();
    const sel = document.getElementById('selInstituicao');
    sel.innerHTML = (j.empresas||[]).map(e=>`<option value="${e.codigo}">${e.nome}</option>`).join('');
  }catch(e){ toast('Erro ao carregar empresas'); }
}
carregarEmpresas();

/* ==========================
    OPEN CADASTRO EMPRESA
========================== */
function abrirCadastroEmpresa(){
  window.open('cadastroempresa.html','cadastroEmpresa','width=700,height=500,scrollbars=yes');
}

/* ==========================
    SALVAR LICITAÇÃO
========================== */
async function salvar(){
  const body = {
    action:'addLicitacao',
    instCode: selInstituicao.value,
    instituicao: selInstituicao.selectedOptions[0]?.text,
    dataSessaoBR: inpData.value.trim(),
    valorBR: inpValor.value.trim(),
    criterio: inpCriterio.value.trim().toUpperCase(),
    modo: inpModo.value.trim().toUpperCase(),
    status: selStatus.value
  };

  if(!body.instCode) return toast('Selecione a INSTITUIÇÃO');

  try{
    const r = await fetch(API,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(body)
    });
    const j = await r.json();
    if(j.error) throw new Error(j.error);

    toast('Licitação criada!', `Código: ${j.codigo}`, true);

    setTimeout(()=>window.close(),900);

  }catch(e){
    toast('Erro ao salvar', e.message);
  }
}
</script>

</body>
</html>
