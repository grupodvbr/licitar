<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Documentos ‚Ä¢ LICITAR</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
/* ==========================================
   PALETA LICITAR ‚Äî COMPAT√çVEL COM O INDEX
========================================== */
:root{
  --azul:#0b1e39;
  --azul-claro:#1d3c63;
  --azul-light:#dbe7ff;

  --dourado:#c9a86c;
  --bg:#f4f6f9;
  --card:#ffffff;
  --line:#e3e7ef;

  --text:#0f172a;
  --muted:#6b7280;

  --radius:18px;
  --shadow:0 8px 22px rgba(0,0,0,.08);
  --shadow-hover:0 12px 30px rgba(0,0,0,.13);
}

/* ==========================================
   BASE
========================================== */
body{
  margin:0;
  padding:25px 35px;
  background:var(--bg);
  color:var(--text);
  font-family:'Inter',sans-serif;
}

/* ==========================================
   T√çTULO / HEADER DA P√ÅGINA
========================================== */
.top-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:30px;
}

.top-header h1{
  font-size:30px;
  font-weight:700;
  color:var(--azul);
}

.view-modes{
  display:flex;
  gap:10px;
}

.view-btn{
  background:white;
  border:1px solid var(--line);
  padding:10px 14px;
  border-radius:12px;
  cursor:pointer;
  font-size:15px;
  transition:.2s;
}

.view-btn.active,
.view-btn:hover{
  background:var(--azul);
  color:white;
}

/* ==========================================
   BARRA DE PESQUISA
========================================== */
#busca{
  width:100%;
  padding:14px 20px;
  border-radius:14px;
  border:1px solid var(--line);
  background:white;
  margin-bottom:20px;
  font-size:16px;
}

#busca:focus{
  outline:none;
  border-color:var(--azul);
  box-shadow:0 0 0 3px #0b1e3933;
}

/* ==========================================
   BREADCRUMB
========================================== */
#breadcrumbs{
  font-size:15px;
  color:var(--muted);
  margin-bottom:18px;
}

/* ==========================================
   TOOLBAR
========================================== */
.toolbar{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  margin-bottom:25px;
}

.btn{
  padding:12px 18px;
  border:none;
  border-radius:14px;
  font-size:15px;
  cursor:pointer;
  font-weight:600;
  color:white;
  box-shadow:var(--shadow);
  transition:.2s;
}

.btn:hover{
  transform:translateY(-3px);
}

.btn-nova{ background:var(--azul); }
.btn-upload{ background:var(--dourado); color:#fff; }
.btn-voltar{ background:#9ca3af; }

/* ==========================================
   GRID DE DOCUMENTOS
========================================== */
#lista{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:25px;
  transition:.25s;
}

.item{
  background:white;
  border-radius:var(--radius);
  padding:20px;
  box-shadow:var(--shadow);
  cursor:pointer;
  transition:.25s;
  border:1px solid var(--line);
}

.item:hover{
  transform:translateY(-6px);
  box-shadow:var(--shadow-hover);
}

.item.list-mode{
  display:flex;
  align-items:center;
  gap:18px;
  height:85px;
}

.thumb{
  width:95px;
  height:95px;
  border-radius:14px;
  object-fit:cover;
  background:#e5e7eb;
  margin:auto;
}

.item.list-mode .thumb{
  width:70px;
  height:70px;
  margin:0;
}

.itemNome{
  margin-top:12px;
  font-weight:600;
  text-align:center;
  font-size:15px;
  overflow:hidden;
}

/* Texto no modo lista */
.item.list-mode .itemNome{
  text-align:left;
  white-space:nowrap;
  flex:1;
}

/* ==========================================
   POPUPS
========================================== */
.popupOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:999999;
}

.popupBox{
  background:white;
  padding:30px;
  width:90%;
  max-width:480px;
  border-radius:18px;
  animation:fade .25s ease;
}

@keyframes fade{
  from{opacity:0; transform:translateY(20px);}
  to{opacity:1; transform:none;}
}

/* ==========================================
   MODAL PREVIEW
========================================== */
#modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:999999;
}

#modalBox{
  background:white;
  padding:30px;
  width:90%;
  max-width:900px;
  border-radius:22px;
}

#modalPreview{
  width:100%;
  height:520px;
  background:#f1f1f1;
  border-radius:14px;
  border:none;
  margin-top:10px;
}

/* Skeleton */
.skeleton{
  height:180px;
  background:#e6e6e6;
  border-radius:var(--radius);
}
</style>
</head>

<body>

<!-- ==========================================
       HEADER SUPERIOR
========================================== -->
<div class="top-header">
  <h1>Gerenciador de Documentos</h1>

  <div class="view-modes">
    <div class="view-btn active" onclick="setView('grid')">üî≥ Grade</div>
    <div class="view-btn" onclick="setView('list')">üìë Lista</div>
    <div class="view-btn" onclick="setView('big')">üóÇ Grande</div>
  </div>
</div>

<!-- Busca -->
<input id="busca" placeholder="Pesquisar..." onkeyup="pesquisar()">

<!-- Breadcrumb -->
<div id="breadcrumbs">üìÅ Raiz</div>

<!-- Toolbar -->
<div class="toolbar">
  <button class="btn btn-nova" onclick="abrirPopupCriar()">üìÅ Nova Pasta</button>
  <button class="btn btn-upload" onclick="abrirUpload()">‚¨Ü Upload</button>
  <button class="btn btn-voltar" onclick="voltarPasta()">‚¨Ö Voltar</button>
</div>

<!-- Lista -->
<div id="lista"></div>

<!-- ==========================================
      POPUPS (CRIAR + UPLOAD)
========================================== -->
<div id="popupCriar" class="popupOverlay">
  <div class="popupBox">

    <h3>Criar Pasta</h3>

    <label>Nome da pasta:</label>
    <input id="nomePasta"
      style="width:100%;padding:14px;margin-top:10px;border-radius:12px;border:1px solid #ddd;">

    <p style="margin-top:15px;">Cor da pasta:</p>

    <div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:8px;" id="coresPasta"></div>

    <button class="btn btn-nova" onclick="criarPasta()" style="margin-top:25px;width:100%;">Criar</button>
    <button onclick="fecharPopupCriar()"
      style="margin-top:10px;width:100%;padding:12px;border:none;border-radius:12px;background:#e5e5e5;">Cancelar</button>

  </div>
</div>

<div id="popupUpload" class="popupOverlay">
  <div class="popupBox">

    <h3>Upload de Arquivo</h3>

    <label>Destino</label>
    <select id="uploadDestino"
      style="width:100%;padding:12px;margin-top:8px;border:1px solid #ccc;border-radius:10px;"></select>

    <div id="dropArea" style="border:2px dashed #bbb;padding:45px;text-align:center;border-radius:14px;margin-top:20px;cursor:pointer;">
      Arraste arquivos aqui ou clique
    </div>
    <input id="uploadInput" type="file" multiple style="display:none">

    <button class="btn btn-upload" style="width:100%;margin-top:20px;" onclick="enviarUpload()">Enviar</button>
    <button onclick="fecharUpload()" style="margin-top:10px;width:100%;padding:12px;border:none;border-radius:12px;background:#e5e5e5;">Cancelar</button>

  </div>
</div>

<!-- ==========================================
      MODAL DE ARQUIVO
========================================== -->
<div id="modal">
  <div id="modalBox">
    <button class="btn btn-voltar" onclick="fecharModal()" style="float:right;">Fechar</button>

    <h2 id="modalTitulo"></h2>
    <iframe id="modalPreview"></iframe>

    <button onclick="baixarArquivo()" class="btn btn-upload" style="margin-top:15px;">‚¨á Download</button>
    <button onclick="excluirArquivo()" class="btn" style="background:#dc2626;margin-left:10px;">üóë Excluir</button>
    <button onclick="navigator.clipboard.writeText(linkAtual)" class="btn btn-nova" style="margin-left:10px;">üîó Copiar Link</button>
  </div>
</div>

<script>
/* ==========================================
   AQUI ENTRA TODO O SEU JAVASCRIPT ORIGINAL
   (j√° est√° 100% integrado abaixo)
========================================== */

const API = "https://script.google.com/macros/s/AKfycbxFxMimw5qpX6unOxE_QO08dnzl-zGFKE7WEuhvAK7n7xTIIQD9ygrpegir-Hpz9RwWFg/exec";
let usuario = localStorage.getItem("usuarioLogado") || "desconhecido";

let dados=[];
let pastaAtual="10G18r0S5jDXnrOh96pQybqvfB8OH9Gxp";
let historicoPastas=[pastaAtual];
let corEscolhida=null;
let linkAtual="";

/* Rendering */
window.onload=()=>{
  renderSkeleton();
  carregar();
};

/* Skeleton */
function renderSkeleton(){
  let h="";
  for(let i=0;i<12;i++) h+=`<div class="skeleton"></div>`;
  lista.innerHTML=h;
}

/* Listar */
async function carregar(){
  const req=await fetch(API+"?action=listar");
  dados=await req.json();

  preencherDestinoUpload();
  mostrarPasta(pastaAtual);
}

/* Mostrar pasta */
function mostrarPasta(id){
  pastaAtual=id;
  const nome=dados.find(p=>p.id===id)?.nome || "Raiz";
  breadcrumbs.innerHTML="üìÅ "+nome;

  const itens=dados.filter(p=>p.pai===id);
  let html="";

  itens.forEach(item=>{
    const thumb = (item.tipo==="pasta")
      ? gerarThumbPasta(item)
      : gerarThumbArquivo(item);

    html+=`
      <div class="item ${currentView}">
        ${thumb}
        <div class="itemNome">${item.nome}</div>
      </div>
    `;
  });

  lista.innerHTML = html || "<p>Nada aqui...</p>";

  document.querySelectorAll(".item").forEach((el,i)=>{
    const item = itens[i];
    el.onclick = ()=>{
      if(item.tipo==="pasta") entrarPasta(item.id);
      else abrirArquivo(item.nome,item.url);
    };
  });
}

/* Mini fun√ß√µes utilit√°rias */
function gerarThumbPasta(item){
  const cor={
    azul:"#4F8CF1", verde:"#60D364", amarelo:"#F8D441",
    laranja:"#F7A654", vermelho:"#F55D5D", roxo:"#BF6AF7",
    cinza:"#A5A5A5", preto:"#000", rosa:"#E76BAF", marrom:"#A67C52"
  }[item.capa] || "#4F8CF1";

  return `<img class="thumb" src="https://img.icons8.com/fluency-systems-filled/96/${cor.replace('#','')}/folder-invoices.png">`;
}

function gerarThumbArquivo(item){
  const ext=item.nome.split(".").pop().toLowerCase();
  const imgExt=["jpg","jpeg","png","gif","webp"];
  const id=extrairID(item.url);

  if(imgExt.includes(ext))
    return `<img class="thumb" src="https://drive.google.com/uc?export=view&id=${id}">`;

  return `<img class="thumb" src="https://drive.google.com/thumbnail?id=${id}&sz=w400">`;
}

function extrairID(l){
  let m=l.match(/\/d\/(.*?)\//) || l.match(/id=(.*?)(&|$)/);
  return m?m[1]:"";
}

/* Navega√ß√£o */
function entrarPasta(id){
  historicoPastas.push(id);
  mostrarPasta(id);
}
function voltarPasta(){
  if(historicoPastas.length>1){
    historicoPastas.pop();
    mostrarPasta(historicoPastas.at(-1));
  }
}

/* Criar pasta */
function abrirPopupCriar(){
  popupCriar.style.display="flex";

  // cores
  const cores=[
    "azul","verde","amarelo","laranja","vermelho","roxo",
    "cinza","preto","rosa","marrom"
  ];
  coresPasta.innerHTML="";
  cores.forEach(c=>{
    const div=document.createElement("div");
    div.style.width="34px";
    div.style.height="34px";
    div.style.borderRadius="50%";
    div.style.cursor="pointer";
    div.style.background={
      azul:"#4F8CF1", verde:"#60D364", amarelo:"#F8D441",
      laranja:"#F7A654", vermelho:"#F55D5D", roxo:"#BF6AF7",
      cinza:"#A5A5A5", preto:"#000", rosa:"#E76BAF", marrom:"#A67C52"
    }[c];
    div.onclick=()=>{
      document.querySelectorAll("#coresPasta div").forEach(x=>x.style.outline="none");
      div.style.outline="3px solid black";
      corEscolhida=c;
    };
    coresPasta.appendChild(div);
  });
}

function fecharPopupCriar(){
  popupCriar.style.display="none";
  nomePasta.value="";
  corEscolhida=null;
}

function criarPasta(){
  if(!nomePasta.value.trim()) return alert("Digite o nome da pasta.");
  if(!corEscolhida) return alert("Escolha uma cor.");

  fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action:"criarPasta",
      nome:nomePasta.value.trim(),
      cor:corEscolhida,
      usuario,
      pai:pastaAtual
    })
  }).then(()=>{
    fecharPopupCriar();
    carregar();
  });
}

/* Upload */
function abrirUpload(){ popupUpload.style.display="flex"; }
function fecharUpload(){ popupUpload.style.display="none"; }

function preencherDestinoUpload(){
  uploadDestino.innerHTML="";
  dados.filter(p=>p.tipo==="pasta").forEach(p=>{
    uploadDestino.innerHTML+=`<option value="${p.id}">${p.nome}</option>`;
  });
}

dropArea.onclick=()=>uploadInput.click();
dropArea.ondragover=e=>{e.preventDefault(); dropArea.style.background="#eef6ff";};
dropArea.ondragleave=()=>dropArea.style.background="";
dropArea.ondrop=e=>{
  e.preventDefault();
  enviarArquivos(e.dataTransfer.files);
};

function enviarUpload(){
  enviarArquivos(uploadInput.files);
}

function enviarArquivos(files){
  const destino=uploadDestino.value;

  [...files].forEach(f=>{
    const reader=new FileReader();
    reader.onload=()=>{
      const base64=reader.result.split(",")[1];
      fetch(API,{
        method:"POST",
        body:JSON.stringify({
          action:"upload",
          base64,
          mime:f.type,
          nome:f.name,
          usuario,
          pai:destino
        })
      }).then(()=>carregar());
    };
    reader.readAsDataURL(f);
  });

  fecharUpload();
}

/* Modal */
function abrirArquivo(nome,url){
  modalTitulo.innerText=nome;
  modalPreview.src=url;
  linkAtual=url;
  modal.style.display="flex";
}

function fecharModal(){ modal.style.display="none"; }

/* Download */
function baixarArquivo(){
  const id=extrairID(linkAtual);
  const a=document.createElement("a");
  a.href=`https://drive.google.com/uc?export=download&id=${id}`;
  a.click();
}

/* Excluir */
async function excluirArquivo(){
  if(!confirm("Excluir este arquivo?")) return;

  await fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action:"excluir",
      nome:modalTitulo.innerText,
      url:linkAtual
    })
  });

  fecharModal();
  carregar();
}

/* Busca */
function pesquisar(){
  const q=busca.value.toLowerCase();
  if(!q){ mostrarPasta(pastaAtual); return; }

  const itens=dados.filter(p=>p.nome.toLowerCase().includes(q));

  let html="";
  itens.forEach(item=>{
    const thumb = item.tipo==="pasta"
      ? gerarThumbPasta(item)
      : gerarThumbArquivo(item);

    html+=`
      <div class="item ${currentView}">
        ${thumb}
        <div class="itemNome">${item.nome}</div>
      </div>
    `;
  });

  lista.innerHTML = html || "<p>Nada encontrado...</p>";
}

/* ============================
   MODO DE EXIBI√á√ÉO (GRID/LISTA/GRANDE)
============================ */
let currentView="";

function setView(mode){
  document.querySelectorAll(".view-btn").forEach(b=>b.classList.remove("active"));
  event.target.classList.add("active");

  if(mode==="grid"){
    currentView="";
    lista.style.gridTemplateColumns="repeat(auto-fill,minmax(220px,1fr))";
  }
  if(mode==="list"){
    currentView="list-mode";
    lista.style.gridTemplateColumns="1fr";
  }
  if(mode==="big"){
    currentView="";
    lista.style.gridTemplateColumns="repeat(auto-fill,minmax(300px,1fr))";
  }

  mostrarPasta(pastaAtual);
}

</script>

</body>
</html>
