<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Documentos ‚Ä¢ LICITAR</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
/* ============================
   ESTILOS (MANTIDOS)
============================ */
:root{
  --azul:#0b1e39;
  --azul-claro:#143559;
  --dourado:#c9a86c;
  --bg:#f4f6f9;
  --card:#ffffff;
  --line:#d9dce3;
  --muted:#6b7280;
  --radius:18px;
  --shadow:0 8px 22px rgba(0,0,0,.08);
  --shadow-big:0 12px 38px rgba(0,0,0,.16);
}

body{
  margin:0;
  padding:35px;
  background:var(--bg);
  font-family:'Inter',sans-serif;
  color:var(--azul);
}

.header{
  display:flex; justify-content:space-between; align-items:center;
  margin-bottom:25px;
}
.header h1{ font-size:30px; font-weight:700; }

.indicador{
  width:18px; height:18px; border-radius:50%; background:#888;
  cursor:pointer; box-shadow:0 0 8px rgba(0,0,0,.2);
}

#diagBox{
  position:fixed; top:80px; right:20px; width:350px;
  background:white; padding:20px; border-radius:18px;
  box-shadow:var(--shadow-big); display:none; z-index:9999;
}

#busca{
  width:100%; padding:14px 20px; border-radius:14px;
  border:1px solid var(--line); font-size:16px; background:white;
}

.toolbar{ margin-top:18px; display:flex; gap:12px; }

.btn{
  padding:12px 18px; border:none; border-radius:14px;
  cursor:pointer; font-weight:600; font-size:14px;
  display:flex; align-items:center; gap:6px; color:white;
  box-shadow:var(--shadow); transition:.2s;
}
.btn:hover{ transform:translateY(-3px); }
.btn-nova{ background:var(--azul); }
.btn-upload{ background:var(--dourado); }
.btn-voltar{ background:#9ca3af; }

#lista{
  margin-top:25px;
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
  gap:22px;
}

.item{
  background:white; padding:18px; border-radius:20px;
  box-shadow:var(--shadow); border:1px solid #e1e4e8;
  cursor:pointer; transition:.2s; text-align:center;
}
.item:hover{ box-shadow:var(--shadow-big); transform:translateY(-4px); }

.thumb{
  width:90px; height:90px; margin:auto; border-radius:12px; object-fit:cover;
}

.itemNome{ margin-top:12px; font-weight:600; font-size:15px; }

.popupOverlay{
  position:fixed; inset:0; background:rgba(0,0,0,.55);
  display:none; justify-content:center; align-items:center; z-index:999999;
}

.popupBox{
  width:90%; max-width:480px; background:white;
  padding:30px; border-radius:22px; box-shadow:var(--shadow-big);
  animation:fade .25s ease;
}

.popupTitle{
  font-size:22px; font-weight:700; margin-bottom:18px;
}

.input{
  width:100%; padding:14px; border-radius:14px;
  border:1px solid var(--line); font-size:16px; margin-bottom:15px;
}

.btn-full{ width:100%; margin-top:8px; }

#dropArea{
  border:2px dashed var(--azul); padding:40px; text-align:center;
  border-radius:16px; cursor:pointer; background:#f8fafc; margin:15px 0;
}
</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
  <h1>Gerenciador de Documentos</h1>
  <div id="statusBall" class="indicador"></div>
</div>

<div id="diagBox"></div>
<input id="busca" placeholder="Pesquisar...">

<div class="toolbar">
  <button class="btn btn-nova" onclick="abrirCriarPasta()">üìÅ Nova Pasta</button>
  <button class="btn btn-upload" onclick="abrirUpload()">‚¨Ü Upload</button>
  <button class="btn btn-voltar" onclick="voltarPasta()">‚¨Ö Voltar</button>
</div>

<div id="lista"></div>

<!-- POPUP CRIAR PASTA -->
<div id="popupCriar" class="popupOverlay">
  <div class="popupBox">
    <div class="popupTitle">Criar Pasta</div>
    <input id="nomePasta" class="input" placeholder="Nome da pasta">
    <button class="btn btn-nova btn-full" onclick="criarPasta()">Criar</button>
    <button class="btn btn-voltar btn-full" onclick="fecharCriarPasta()">Cancelar</button>
  </div>
</div>

<!-- POPUP UPLOAD -->
<div id="popupUpload" class="popupOverlay">
  <div class="popupBox">
    <div class="popupTitle">Enviar Arquivos</div>

    <div id="dropArea">Clique ou arraste arquivos aqui</div>
    <input id="uploadInput" type="file" multiple style="display:none">

    <button class="btn btn-upload btn-full" onclick="enviarUpload()">Enviar</button>
    <button class="btn btn-voltar btn-full" onclick="fecharUpload()">Cancelar</button>
  </div>
</div>

<script>
/* ==========================================
   SUPABASE CONFIG
========================================== */
const SUPABASE_URL = "https://mblvyircwsaxaslklzky.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_oN2CuBzXHaUF7NHYS_M7aw_tBqVeD-x";
const BUCKET = "licitardocs";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ==========================================
   STATUS / DEBUG
========================================== */
async function testarConexao(){
  let ball = document.getElementById("statusBall");
  let diag = document.getElementById("diagBox");

  try{
    const { data, error } = await supabase.storage.from(BUCKET).list("");

    if(error) throw error;

    // Conectado
    ball.style.background = "#16a34a";
    ball.onclick = () => {
      diag.innerHTML = `
        <h3 style="margin:0 0 10px 0;color:#16a34a">Conectado ao Supabase</h3>
        <small style="color:#555">Bucket: ${BUCKET}</small>
        <pre style="margin-top:15px;background:#f1f5f9;padding:10px;border-radius:8px">${JSON.stringify(data,null,2)}</pre>
      `;
      diag.style.display = "block";
    };

  } catch(err){
    // Erro real
    ball.style.background = "#dc2626";
    ball.onclick = () => {
      diag.innerHTML = `
        <h3 style="margin:0 0 10px 0;color:#dc2626">Erro de Conex√£o</h3>
        <pre style="margin-top:15px;background:#fee2e2;padding:10px;border-radius:8px">${err.message}</pre>
      `;
      diag.style.display = "block";
    };
  }
}

testarConexao();

/* ==========================================
   VARI√ÅVEIS
========================================== */
let pastaAtual = null;
let historicoPastas = [];
let arquivos = [];

/* ==========================================
   LISTAR DOCUMENTOS
========================================== */
async function carregar(){
  let { data } = await supabase.from("documentos")
    .select("*")
    .eq("pai", pastaAtual);

  arquivos = data || [];
  render();
}
carregar();

/* ==========================================
   RENDER
========================================== */
function render(){
  let html = "";

  arquivos.forEach((item)=>{
    let icon = item.tipo === "pasta"
      ? "https://img.icons8.com/fluency/96/folder-invoices.png"
      : item.url;

    html += `
      <div class="item" onclick="abrirItem(${item.id},'${item.tipo}','${item.url}')">
        <img class="thumb" src="${icon}">
        <div class="itemNome">${item.nome}</div>
      </div>`;
  });

  document.getElementById("lista").innerHTML = html || "<p>Nada encontrado.</p>";
}

/* ==========================================
   ABRIR ITEM
========================================== */
function abrirItem(id,tipo,url){
  if(tipo === "pasta"){
    pastaAtual = id;
    historicoPastas.push(id);
    carregar();
  } else {
    window.open(url,"_blank");
  }
}

/* ==========================================
   VOLTAR PASTA
========================================== */
function voltarPasta(){
  historicoPastas.pop();
  pastaAtual = historicoPastas[historicoPastas.length-1] || null;
  carregar();
}

/* ==========================================
   POPUP: CRIAR PASTA
========================================== */
function abrirCriarPasta(){ popupCriar.style.display="flex"; }
function fecharCriarPasta(){ popupCriar.style.display="none"; }

async function criarPasta(){
  const nome = nomePasta.value.trim();
  if(!nome) return alert("Digite o nome da pasta.");

  const { data: user } = await supabase.auth.getUser();

  await supabase.from("documentos").insert({
    nome: nome,
    tipo: "pasta",
    pai: pastaAtual,
    url: null,
    usuario: user.user.id
  });

  fecharCriarPasta();
  carregar();
}

/* ==========================================
   POPUP UPLOAD
========================================== */
function abrirUpload(){ popupUpload.style.display="flex"; }
function fecharUpload(){ popupUpload.style.display="none"; }

/* DRAG & DROP */
dropArea.onclick = () => uploadInput.click();
dropArea.ondragover = e => { e.preventDefault(); dropArea.style.background="#e8eef9"; };
dropArea.ondragleave = () => dropArea.style.background="#f8fafc";
dropArea.ondrop = e => {
  e.preventDefault();
  uploadInput.files = e.dataTransfer.files;
  dropArea.style.background="#f8fafc";
};

/* ==========================================
   UPLOAD FINAL ‚Äî 100% FUNCIONAL
========================================== */
async function enviarUpload(){
  const files = uploadInput.files;
  if(!files?.length) return alert("Selecione algum arquivo!");

  const { data: user } = await supabase.auth.getUser();
  const usuario = user.user.id;

  for(let file of files){
    const path = `${usuario}/${pastaAtual || "root"}/${Date.now()}_${file.name}`;

    // 1. Upload
    const { error: upErr } = await supabase.storage.from(BUCKET).upload(path, file);
    if(upErr){
      alert("Erro no upload: " + upErr.message);
      continue;
    }

    // 2. Public URL
    const pub = supabase.storage.from(BUCKET).getPublicUrl(path).data.publicUrl;

    // 3. Inserir registro
    const { error: dbErr } = await supabase.from("documentos").insert({
      nome: file.name,
      tipo: "arquivo",
      pai: pastaAtual,
      mime: file.type,
      url: pub,
      storage_path: path,
      usuario: usuario
    });

    if(dbErr){
      alert("Erro ao registrar no banco: " + dbErr.message);
      continue;
    }
  }

  fecharUpload();
  carregar();
}
</script>

</body>
</html>
