<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Documentos ‚Ä¢ LICITAR</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
/* ( SEU CSS EXATO ‚Äî n√£o alterei nada ) */
... (todo o seu CSS continua igual, sem mudan√ßas)
</style>
</head>

<body>

<!-- (SEU HTML EXATO ‚Äî mantido) -->
... (todo o HTML do layout continua igual)

<script>
/* ==========================================
      CONFIGURA√á√ÉO SUPABASE
========================================== */

const SUPABASE_URL = "https://SEU-PROJETO.supabase.co";
const SUPABASE_ANON_KEY = "SUA-ANON-KEY";

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const BUCKET = "licitardocs"; // o bucket criado

let dados = [];
let pastaAtual = null;
let historicoPastas = [];

/* ==========================================
      INICIALIZA√á√ÉO
========================================== */

window.onload = () => {
  renderSkeleton();
  carregarPasta(null); // raiz
};

/* ==========================================
      LISTAR PASTA
========================================== */

async function carregarPasta(pai) {
  pastaAtual = pai;
  historicoPastas.push(pai);

  const { data, error } = await supabase
    .from("documentos")
    .select("*")
    .eq("pai", pai);

  dados = data || [];

  renderLista();
  atualizarBreadcrumb();
}

/* ==========================================
      RENDER LISTA
========================================== */

function renderLista() {
  let html = "";

  dados.forEach(item => {
    const thumb = item.tipo === "pasta"
      ? gerarThumbPasta(item)
      : gerarThumbArquivo(item);

    html += `
      <div class="item ${currentView}">
        ${thumb}
        <div class="itemNome">${item.nome}</div>
      </div>
    `;
  });

  lista.innerHTML = html || "<p style='padding:10px;'>Nenhum arquivo encontrado.</p>";

  document.querySelectorAll(".item").forEach((el, i) => {
    const item = dados[i];
    el.onclick = () => {
      if (item.tipo === "pasta") carregarPasta(item.id);
      else abrirArquivo(item.nome, item.url);
    };
  });
}

/* ==========================================
      BREADCRUMB
========================================== */

async function atualizarBreadcrumb() {
  if (!pastaAtual) {
    breadcrumbs.innerHTML = "üìÅ Raiz";
    return;
  }

  const { data } = await supabase
    .from("documentos")
    .select("nome")
    .eq("id", pastaAtual)
    .single();

  breadcrumbs.innerHTML = "üìÅ " + (data?.nome || "Raiz");
}

/* ==========================================
      VOLTAR PASTA
========================================== */

async function voltarPasta() {
  if (historicoPastas.length > 1) {
    historicoPastas.pop();
    carregarPasta(historicoPastas[historicoPastas.length - 1]);
  }
}

/* ==========================================
      THUMBNAILS
========================================== */

function gerarThumbPasta(item) {
  const cores = {
    azul:"#4F8CF1", verde:"#60D364", amarelo:"#F8D441",
    laranja:"#F7A654", vermelho:"#F55D5D", roxo:"#BF6AF7",
    cinza:"#A5A5A5", preto:"#000", rosa:"#E76BAF", marrom:"#A67C52"
  };

  const cor = cores[item.cor] || "#4F8CF1";
  const hex = cor.replace("#","");

  return `
    <img class="thumb"
    src="https://img.icons8.com/fluency-systems-filled/96/${hex}/folder-invoices.png">
  `;
}

function gerarThumbArquivo(item) {
  return `<img class="thumb" src="${item.url}">`;
}

/* ==========================================
      CRIAR PASTA
========================================== */

async function criarPasta() {
  const nome = nomePasta.value.trim();
  if (!nome || !corEscolhida) return alert("Preencha tudo.");

  const { error } = await supabase
    .from("documentos")
    .insert({
      nome,
      tipo: "pasta",
      pai: pastaAtual,
      cor: corEscolhida,
      mime: null,
      url: null,
      storage_path: null
    });

  fecharPopupCriar();
  carregarPasta(pastaAtual);
}

/* ==========================================
      UPLOAD DE ARQUIVOS
========================================== */

async function enviarArquivos(files) {
  for (let file of files) {

    const path = `${pastaAtual || "root"}/${Date.now()}_${file.name}`;

    // 1 ‚Äî Upload pro bucket
    let { data: upload, error: uploadErr } = await supabase
      .storage
      .from(BUCKET)
      .upload(path, file);

    if (uploadErr) {
      console.log(uploadErr);
      alert("Erro ao enviar arquivo.");
      continue;
    }

    // 2 ‚Äî URL p√∫blica
    const { data: pub } = supabase
      .storage
      .from(BUCKET)
      .getPublicUrl(path);

    const url = pub.publicUrl;

    // 3 ‚Äî Registrar na tabela
    await supabase.from("documentos").insert({
      nome: file.name,
      tipo: "arquivo",
      pai: pastaAtual,
      mime: file.type,
      url,
      storage_path: path
    });
  }

  fecharUpload();
  carregarPasta(pastaAtual);
}

/* ==========================================
      EXIBIR / EXCLUIR ARQUIVO
========================================== */

function abrirArquivo(nome, url) {
  modalTitulo.innerText = nome;
  modalPreview.src = url;
  linkAtual = url;

  modal.style.display = "flex";
}

async function excluirArquivo() {
  if (!confirm("Excluir este arquivo?")) return;

  const { data } = await supabase
    .from("documentos")
    .select("storage_path")
    .eq("url", linkAtual)
    .single();

  if (data?.storage_path) {
    await supabase.storage.from(BUCKET).remove([data.storage_path]);
  }

  await supabase
    .from("documentos")
    .delete()
    .eq("url", linkAtual);

  fecharModal();
  carregarPasta(pastaAtual);
}

/* ==========================================
      MODO DE EXIBI√á√ÉO
========================================== */

let currentView = "";

function setView(mode) {
  document.querySelectorAll(".view-btn").forEach(b=>b.classList.remove("active"));
  event.target.classList.add("active");

  if (mode === "grid") {
    currentView = "";
    lista.style.gridTemplateColumns = "repeat(auto-fill,minmax(220px,1fr))";
  }
  if (mode === "list") {
    currentView = "list-mode";
    lista.style.gridTemplateColumns = "1fr";
  }
  if (mode === "big") {
    currentView = "";
    lista.style.gridTemplateColumns = "repeat(auto-fill,minmax(300px,1fr))";
  }

  renderLista();
}

</script>

</body>
</html>
