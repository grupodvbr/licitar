<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Documentos ‚Ä¢ LICITAR</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
/* ======================================
   ESTILO PREMIUM LICITAR
====================================== */
:root{
  --azul:#0b1e39;
  --azul-claro:#143559;
  --dourado:#c9a86c;
  --bg:#f4f6f9;
  --line:#d9dce3;
  --radius:18px;
  --shadow:0 8px 22px rgba(0,0,0,.08);
  --shadow-big:0 12px 38px rgba(0,0,0,.16);
}
body{
  margin:0; padding:35px; background:var(--bg);
  font-family:'Inter',sans-serif; color:var(--azul);
}

.header{
  display:flex; justify-content:space-between; align-items:center;
  margin-bottom:25px;
}
.header h1{ font-size:30px; font-weight:700; }

.indicador{
  width:18px; height:18px; border-radius:50%; background:#888;
  cursor:pointer; box-shadow:0 0 8px rgba(0,0,0,.2);
}

#diagBox{
  position:fixed; top:80px; right:20px; width:350px;
  background:white; padding:20px; border-radius:18px; display:none;
  box-shadow:var(--shadow-big); z-index:999;
}

#busca{
  width:100%; padding:14px; border-radius:14px;
  border:1px solid var(--line); font-size:16px; background:white;
}

.toolbar{ margin-top:18px; display:flex; gap:12px; }

.btn{
  padding:12px 18px; border:none; border-radius:14px;
  cursor:pointer; font-weight:600; font-size:14px; color:white;
  display:flex; align-items:center; gap:6px;
  box-shadow:var(--shadow); transition:.2s;
}
.btn:hover{ transform:translateY(-3px); }

.btn-nova{ background:var(--azul); }
.btn-upload{ background:var(--dourado); }
.btn-voltar{ background:#9ca3af; }

#lista{
  margin-top:25px;
  display:grid; gap:22px;
  grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
}

.item{
  background:white; padding:18px; border-radius:20px;
  box-shadow:var(--shadow); text-align:center;
  border:1px solid #e1e4e8; cursor:pointer; transition:.2s;
}
.item:hover{ box-shadow:var(--shadow-big); transform:translateY(-4px); }

.thumb{ width:90px; height:90px; object-fit:cover; margin:auto; border-radius:12px; }
.itemNome{ margin-top:12px; font-weight:600; }

.popupOverlay{
  position:fixed; inset:0; display:none;
  background:rgba(0,0,0,.55); z-index:9999;
  justify-content:center; align-items:center;
}
.popupBox{
  width:90%; max-width:480px; background:white;
  padding:30px; border-radius:22px; box-shadow:var(--shadow-big);
}
.popupTitle{ font-size:22px; font-weight:700; margin-bottom:18px; }

.input{
  width:100%; padding:14px; border-radius:14px;
  border:1px solid var(--line); font-size:16px;
  margin-bottom:15px;
}
.btn-full{ width:100%; margin-top:8px; }

#dropArea{
  border:2px dashed var(--azul);
  padding:40px; background:#f8fafc;
  border-radius:16px; text-align:center;
  cursor:pointer; margin:15px 0;
}
</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
  <h1>Gerenciador de Documentos</h1>
  <div id="statusBall" class="indicador"></div>
</div>

<div id="diagBox"></div>

<input id="busca" placeholder="Pesquisar...">

<div class="toolbar">
  <button class="btn btn-nova" onclick="abrirCriarPasta()">üìÅ Nova Pasta</button>
  <button class="btn btn-upload" onclick="abrirUpload()">‚¨Ü Upload</button>
  <button class="btn btn-voltar" onclick="voltarPasta()">‚¨Ö Voltar</button>
</div>

<div id="lista"></div>

<!-- POPUP PASTA -->
<div id="popupCriar" class="popupOverlay">
  <div class="popupBox">
    <div class="popupTitle">Criar Pasta</div>
    <input id="nomePasta" class="input" placeholder="Nome da pasta">
    <button class="btn btn-nova btn-full" onclick="criarPasta()">Criar</button>
    <button class="btn btn-voltar btn-full" onclick="fecharCriarPasta()">Cancelar</button>
  </div>
</div>

<!-- POPUP UPLOAD -->
<div id="popupUpload" class="popupOverlay">
  <div class="popupBox">
    <div class="popupTitle">Enviar Arquivos</div>

    <div id="dropArea">Clique ou arraste arquivos aqui</div>
    <input id="uploadInput" type="file" multiple style="display:none">

    <button class="btn btn-upload btn-full" onclick="enviarUpload()">Enviar</button>
    <button class="btn btn-voltar btn-full" onclick="fecharUpload()">Cancelar</button>
  </div>
</div>

<script>
/* ===========================================================
      SUPABASE CONFIG
=========================================================== */
const SUPABASE_URL = "https://mblvyircwsaxaslklzky.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_oN2CuBzXHaUF7NHYS_M7aw_tBqVeD-x";
const BUCKET = "licitardocs";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===========================================================
      LOGIN LOCAL
=========================================================== */
let usuario = null;

async function validarLogin(){
  let saved = localStorage.getItem("licitarUser");

  if(saved){
    usuario = JSON.parse(saved);
    return true;
  }

  const { data } = await sb.auth.getSession();

  if(data.session){
    usuario = {
      id: data.session.user.id,
      email: data.session.user.email
    };
    localStorage.setItem("licitarUser", JSON.stringify(usuario));
    return true;
  }

  alert("Acesso restrito. Fa√ßa login primeiro.");
  window.top.location.href = "index.html";
}

await validarLogin();

/* ===========================================================
      TESTE CONEX√ÉO ‚Äî BOLINHA VERDE
=========================================================== */
async function testarConexao(){
  const ball = document.getElementById("statusBall");
  const diag = document.getElementById("diagBox");

  try{
    const { data: bucketInfo, error } = await sb.storage.getBucket(BUCKET);
    if(error) throw error;

    ball.style.background = "#16a34a";
    ball.onclick = ()=>{
      diag.style.display="block";
      diag.innerHTML = `
        <h3 style="color:#16a34a;margin-bottom:8px">Conectado ao Supabase</h3>
        <pre style="background:#eef;padding:10px;border-radius:10px">${JSON.stringify(bucketInfo,null,2)}</pre>
      `;
    };
  }
  catch(err){
    ball.style.background = "#dc2626";
  }
}

testarConexao();

/* ===========================================================
      VARI√ÅVEIS
=========================================================== */
let pastaAtual = null;
let historicoPastas = [];
let listaItens = [];

/* ===========================================================
      CARREGAR ITENS DO USU√ÅRIO
=========================================================== */
async function carregar(){
  const { data } = await sb
    .from("documentos")
    .select("*")
    .eq("pai", pastaAtual)
    .eq("usuario_email", usuario.email);

  listaItens = data || [];
  render();
}

carregar();

/* ===========================================================
      RENDER
=========================================================== */
function render(){
  let html = "";

  listaItens.forEach(it=>{
    let icon = it.tipo==="pasta"
      ? "https://img.icons8.com/fluency/96/folder-invoices.png"
      : it.url;

    html += `
      <div class="item" onclick="abrirItem(${it.id},'${it.tipo}','${it.url}')">
        <img class="thumb" src="${icon}">
        <div class="itemNome">${it.nome}</div>
      </div>`;
  });

  lista.innerHTML = html || "<p>Vazio.</p>";
}

/* ===========================================================
      ABRIR ITEM
=========================================================== */
function abrirItem(id,tipo,url){
  if(tipo==="pasta"){
    pastaAtual=id;
    historicoPastas.push(id);
    carregar();
  } else {
    window.open(url,"_blank");
  }
}

/* ===========================================================
      VOLTAR
=========================================================== */
function voltarPasta(){
  historicoPastas.pop();
  pastaAtual = historicoPastas[historicoPastas.length-1] || null;
  carregar();
}

/* ===========================================================
      PASTA
=========================================================== */
function abrirCriarPasta(){ popupCriar.style.display="flex"; }
function fecharCriarPasta(){ popupCriar.style.display="none"; }

async function criarPasta(){
  let nome = nomePasta.value.trim();
  if(!nome) return alert("Digite um nome.");

  await sb.from("documentos").insert({
    nome:nome,
    tipo:"pasta",
    pai:pastaAtual,
    url:null,
    usuario_id:usuario.id,
    usuario_email:usuario.email
  });

  fecharCriarPasta();
  carregar();
}

/* ===========================================================
      UPLOAD
=========================================================== */
function abrirUpload(){ popupUpload.style.display="flex"; }
function fecharUpload(){ popupUpload.style.display="none"; }

dropArea.onclick = ()=> uploadInput.click();
dropArea.ondragover = e => { e.preventDefault(); dropArea.style.background="#e8eef9"; };
dropArea.ondragleave = ()=> dropArea.style.background="#f8fafc";
dropArea.ondrop = e =>{
  e.preventDefault();
  uploadInput.files = e.dataTransfer.files;
};

async function enviarUpload(){
  const files = uploadInput.files;
  if(!files.length) return alert("Selecione arquivos.");

  for(let file of files){
    const path = `${usuario.email}/${pastaAtual||"root"}/${Date.now()}_${file.name}`;

    const up = await sb.storage.from(BUCKET).upload(path,file);
    if(up.error){
      alert("Erro no upload: "+up.error.message);
      continue;
    }

    const publicURL = sb.storage.from(BUCKET)
      .getPublicUrl(path).data.publicUrl;

    await sb.from("documentos").insert({
      nome:file.name,
      tipo:"arquivo",
      pai:pastaAtual,
      mime:file.type,
      url:publicURL,
      storage_path:path,
      usuario_id:usuario.id,
      usuario_email:usuario.email
    });
  }

  fecharUpload();
  carregar();
}
</script>

</body>
</html>
