<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Documentos ‚Ä¢ Sistema</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">

<style>

/* ======================================================
          PALETA PREMIUM ‚Ä¢ AZUL + DOURADO
   ====================================================== */
:root{
  --azul:#0b1e39;
  --azul2:#152b45;
  --azul3:#1e3a5f;
  --gold:#c9a86c;
  --gold2:#b89259;
  --bg1:#eef2f6;
  --bg2:#f7f8fc;
  --white:#ffffff;
  --glass:#ffffffcc;
  --border:#d7dce5;
  --shadow-big:0 30px 60px rgba(0,0,0,.16);
  --shadow-card:0 10px 28px rgba(0,0,0,.10);
  --radius:26px;
}

/* ======================================================
                     LAYOUT GERAL
   ====================================================== */
body{
  margin:0;
  padding:0;
  background:linear-gradient(160deg,var(--bg1),var(--bg2));
  font-family:'Inter',sans-serif;
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:flex-start;
}

#container{
  width:94%;
  max-width:1700px;
  margin-top:45px;
  background:var(--glass);
  padding:55px;
  border-radius:32px;
  backdrop-filter:blur(32px) saturate(170%);
  box-shadow:var(--shadow-big);
  animation:fadeIn .5s ease-out;
}

@keyframes fadeIn{
  from{opacity:0; transform:translateY(30px);}
  to{opacity:1; transform:none;}
}

/* ======================================================
                        T√çTULO
   ====================================================== */
#titulo{
  text-align:center;
  margin:0 0 40px 0;
  font-size:42px;
  font-weight:900;
  color:var(--azul);
  letter-spacing:-1px;
  text-shadow:0 3px 8px rgba(0,0,0,.15);
}

/* ======================================================
                        BUSCA
   ====================================================== */
.searchBox{
  position:relative;
  width:100%;
  margin-bottom:25px;
}

.searchBox i{
  position:absolute;
  left:18px;
  top:50%;
  transform:translateY(-50%);
  font-size:20px;
  color:#738090;
}

#busca{
  width:100%;
  padding:17px 22px 17px 52px;
  border-radius:18px;
  border:2px solid var(--border);
  background:#ffffff;
  font-size:18px;
  box-shadow:0 6px 22px rgba(0,0,0,.08);
  transition:.25s;
}

#busca:focus{
  border-color:var(--gold);
  box-shadow:0 0 0 4px #c9a86c44;
  outline:none;
}

/* ======================================================
                    BREADCRUMB
   ====================================================== */
#breadcrumbs{
  background:#fff;
  padding:12px 22px;
  display:inline-block;
  font-size:18px;
  font-weight:600;
  color:var(--azul2);
  border-radius:16px;
  box-shadow:0 8px 22px rgba(0,0,0,.10);
  margin-bottom:32px;
}

/* ======================================================
                       BOT√ïES
   ====================================================== */
.toolbar{
  display:flex;
  gap:18px;
  margin-bottom:38px;
  flex-wrap:wrap;
}

.btn{
  padding:15px 26px;
  border:none;
  border-radius:14px;
  font-size:16px;
  font-weight:700;
  cursor:pointer;
  transition:.25s;
  color:white;
  box-shadow:0 8px 22px rgba(0,0,0,.15);
}
.btn:hover{
  transform:translateY(-4px);
  opacity:.92;
}

.btn-nova{
  background:var(--azul);
}
.btn-upload{
  background:linear-gradient(135deg,var(--gold),var(--gold2));
  color:#1a1a1a;
}
.btn-voltar{
  background:#6b7280;
}

/* ======================================================
                        GRID
   ====================================================== */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(250px,1fr));
  gap:35px;
}

/* ======================================================
                 CARD ‚Ä¢ FIXO + ROLAGEM
   ====================================================== */
.item{
  background:#ffffff;
  border-radius:var(--radius);
  padding:22px;
  border:1px solid #e5e7eb;
  box-shadow:var(--shadow-card);
  overflow:hidden;
  display:flex;
  flex-direction:column;

  /* altura fixa */
  height:305px;
  transition:.25s;
}

.item:hover{
  transform:translateY(-8px) scale(1.03);
  box-shadow:0 15px 32px rgba(0,0,0,.18);
}

/* √°rea interna rol√°vel */
.itemInner{
  flex:1;
  overflow-y:auto;
  padding-right:6px;
  scrollbar-width:thin;
}

/* THUMB */
.thumb{
  width:120px;
  height:120px;
  border-radius:22px;
  object-fit:cover;
  margin:auto;
  background:#e5e5e5;
}

/* nome */
.itemNome{
  margin-top:14px;
  font-size:17px;
  font-weight:600;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* ======================================================
                POPUPS / MODAL
   ====================================================== */
#popupCriar, #popupUpload, #modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:9999;
}

#popupBox, #uploadBox{
  background:white;
  width:92%;
  max-width:520px;
  padding:40px;
  border-radius:28px;
  box-shadow:0 22px 55px rgba(0,0,0,.25);
  animation:popup .25s ease-out;
}

@keyframes popup{
  from{opacity:0; transform:scale(.92);}
  to{opacity:1;}
}

.colorRow{
  display:flex;
  flex-wrap:wrap;
  gap:14px;
}
.colorSelect{
  width:40px;
  height:40px;
  border-radius:50%;
  cursor:pointer;
  transition:.2s;
  border:3px solid transparent;
}
.colorSelect:hover{
  transform:scale(1.1);
}
.colorSelect.active{
  border-color:#000;
}

#modalBox{
  background:white;
  padding:38px;
  border-radius:28px;
  width:96%;
  max-width:1000px;
}

#modalPreview{
  width:100%;
  height:540px;
  border:none;
  border-radius:20px;
  margin-top:15px;
  background:#f2f2f2;
}

/* skeleton */
.skeleton{
  background:#e6e6e6;
  border-radius:22px;
  height:200px;
}

</style>
</head>

<body>

<div id="container">

  <h1 id="titulo">üìÅ Gerenciador de Documentos</h1>

  <div class="searchBox">
    <i>üîç</i>
    <input id="busca" placeholder="Pesquisar documentos..." onkeyup="pesquisar()">
  </div>

  <div id="breadcrumbs">üìÇ Raiz</div>

  <div class="toolbar">
    <button class="btn btn-nova" onclick="abrirPopupCriar()">üìÅ Nova Pasta</button>
    <button class="btn btn-upload" onclick="abrirUpload()">‚¨Ü Upload</button>
    <button class="btn btn-voltar" onclick="voltarPasta()">‚¨Ö Voltar</button>
  </div>

  <div id="lista" class="grid"></div>

</div>

<!-- ======================================================
                  POPUP CRIAR PASTA
====================================================== -->
<div id="popupCriar">
  <div id="popupBox">
    <h3 style="margin-top:0;font-size:22px;font-weight:700;color:var(--azul);">Criar nova pasta</h3>

    <label>Nome da pasta:</label>
    <input id="nomePasta"
      style="width:100%;padding:15px;border-radius:14px;border:1px solid #ccc;margin-top:6px;font-size:16px;">

    <p style="margin-top:18px;font-weight:600;">Cor da pasta:</p>

    <div class="colorRow">
      <div class="colorSelect" style="background:#2563eb" data-cor="azul"></div>
      <div class="colorSelect" style="background:#4caf50" data-cor="verde"></div>
      <div class="colorSelect" style="background:#facc15" data-cor="amarelo"></div>
      <div class="colorSelect" style="background:#fb923c" data-cor="laranja"></div>
      <div class="colorSelect" style="background:#ef4444" data-cor="vermelho"></div>
      <div class="colorSelect" style="background:#a855f7" data-cor="roxo"></div>
      <div class="colorSelect" style="background:#737373" data-cor="cinza"></div>
      <div class="colorSelect" style="background:#000" data-cor="preto"></div>
      <div class="colorSelect" style="background:#ec4899" data-cor="rosa"></div>
      <div class="colorSelect" style="background:#8b5e3c" data-cor="marrom"></div>
    </div>

    <button onclick="criarPasta()" class="btn btn-nova" style="width:100%;margin-top:22px;">Criar pasta</button>
    <button onclick="fecharPopupCriar()"
      style="margin-top:12px;border:none;background:#e5e7eb;padding:14px;width:100%;border-radius:14px;font-weight:600;">Cancelar</button>
  </div>
</div>

<!-- ======================================================
                     POPUP UPLOAD
====================================================== -->
<div id="popupUpload">
  <div id="uploadBox">

    <h3 style="margin-top:0;font-size:22px;font-weight:700;color:var(--azul);">Enviar arquivo</h3>

    <label>Enviar para:</label>
    <select id="uploadDestino"
      style="width:100%;padding:14px;margin-top:8px;border-radius:14px;border:1px solid #ccc;font-size:16px;"></select>

    <div id="dropArea"
      style="border:2px dashed #b5b5b5;padding:50px;text-align:center;border-radius:22px;margin-top:20px;background:#fafafa;">
      Arraste arquivos aqui<br>ou clique para selecionar
    </div>

    <input id="uploadInput" type="file" multiple style="display:none">

    <button onclick="enviarUpload()" class="btn btn-upload" style="width:100%;margin-top:22px;">Enviar</button>

    <button onclick="fecharUpload()"
      style="margin-top:12px;border:none;background:#e5e7eb;padding:14px;width:100%;border-radius:14px;font-weight:600;">Cancelar</button>
  </div>
</div>

<!-- ======================================================
                         MODAL
====================================================== -->
<div id="modal">
  <div id="modalBox">

    <button class="btn btn-voltar" onclick="fecharModal()" style="float:right;">Fechar</button>

    <h2 id="modalTitulo" style="margin:0;"></h2>

    <iframe id="modalPreview"></iframe>

    <button onclick="baixarArquivo()" class="btn btn-upload" style="margin-top:18px;">‚¨á Download</button>

    <button onclick="excluirArquivo()" class="btn"
      style="margin-left:8px;background:#d9534f;">üóë Excluir</button>

    <button onclick="navigator.clipboard.writeText(linkAtual)" class="btn btn-nova"
      style="margin-left:8px;">üîó Copiar Link</button>

  </div>
</div>

<!-- ======================================================
                  JAVASCRIPT ORIGINAL
====================================================== -->
<script>
/* JS INALTERADO */
</script>

<script>

/* ======================================================
      JS ORIGINAL REINTEGRADO COMPLETO (100% igual)
====================================================== */

const API = "https://script.google.com/macros/s/AKfycbxFxMimw5qpX6unOxE_QO08dnzl-zGFKE7WEuhvAK7n7xTIIQD9ygrpegir-Hpz9RwWFg/exec";
let usuario = localStorage.getItem("usuarioLogado") || "desconhecido";

let dados = [];
let pastaAtual = "10G18r0S5jDXnrOh96pQybqvfB8OH9Gxp";
let historicoPastas = ["10G18r0S5jDXnrOh96pQybqvfB8OH9Gxp"];
let corEscolhida = null;
let linkAtual = "";


/* LOADING */
window.onload = ()=>{
  renderSkeleton();
  carregar();
};

function renderSkeleton(){
  let html="";
  for(let i=0;i<12;i++){
    html+=`<div class="skeleton"></div>`;
  }
  document.getElementById("lista").innerHTML = html;
}

/* LISTAR */
async function carregar(){
  const req = await fetch(API+"?action=listar");
  dados = await req.json();

  preencherDestinoUpload();
  mostrarPasta(pastaAtual);
}

function mostrarPasta(id){
  pastaAtual = id;

  const nome = dados.find(p=>p.id===id)?.nome || "Raiz";
  document.getElementById("breadcrumbs").innerText = "üìÅ " + nome;

  const itens = dados.filter(p=>p.pai===id);

  let html = "";

  itens.forEach(item => {

    html += `
      <div class="item" onclick="${item.tipo==="pasta"
        ? `entrarPasta('${item.id}')`
        : `abrirArquivo('${item.nome}','${item.url}')`
      }">
        <div class="itemInner">
          ${item.tipo==="pasta"
            ? svgCor(item.capa)
            : gerarThumbnail(item.url,item.nome)
          }
          <div class="itemNome">${item.nome}</div>
        </div>
      </div>
    `;
  });

  document.getElementById("lista").innerHTML = html || "Vazio.";
}

function svgCor(cor){
  const cores = {
    azul:"#4F8CF1", verde:"#60D364", amarelo:"#F8D441",
    laranja:"#F7A654", vermelho:"#F55D5D", roxo:"#BF6AF7",
    cinza:"#A5A5A5", preto:"#000", rosa:"#E76BAF", marrom:"#A67C52"
  };

  return `
  <img class="thumb" style="object-fit:contain;"
    src="https://img.icons8.com/fluency-systems-filled/96/${cores[cor] ? cores[cor].replace('#','') : '4F8CF1'}/folder-invoices.png">
  `;
}

function gerarThumbnail(url,nome){
  let ext = nome.split(".").pop().toLowerCase();
  const imgExt = ["jpg","jpeg","png","gif","webp"];
  let id = extrairID(url);

  if(imgExt.includes(ext)){
    return `<img class="thumb" src="https://drive.google.com/uc?export=view&id=${id}">`;
  }

  return `<img class="thumb" src="https://drive.google.com/thumbnail?id=${id}&sz=w256">`;
}

function extrairID(link){
  let m = link.match(/\/d\/(.*?)\//) || link.match(/id=(.*?)(&|$)/);
  return m ? m[1] : "";
}

/* NAVEGA√á√ÉO */
function entrarPasta(id){
  historicoPastas.push(id);
  mostrarPasta(id);
}

function voltarPasta(){
  if(historicoPastas.length>1){
    historicoPastas.pop();
    mostrarPasta(historicoPastas[historicoPastas.length-1]);
  }
}

/* POPUPS */
document.querySelectorAll(".colorSelect").forEach(c=>{
  c.onclick = ()=>{
    document.querySelectorAll(".colorSelect").forEach(x=>x.classList.remove("active"));
    c.classList.add("active");
    corEscolhida = c.dataset.cor;
  };
});

function abrirPopupCriar(){
  document.getElementById("popupCriar").style.display="flex";
}
function fecharPopupCriar(){
  document.getElementById("popupCriar").style.display="none";
  document.getElementById("nomePasta").value="";
  corEscolhida=null;
}

function criarPasta(){
  const nome = document.getElementById("nomePasta").value.trim();
  if(!nome) return alert("Digite o nome.");
  if(!corEscolhida) return alert("Escolha a cor.");

  fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action:"criarPasta",
      nome:nome,
      cor:corEscolhida,
      usuario:usuario,
      pai:pastaAtual
    })
  }).then(()=>{
    fecharPopupCriar();
    carregar();
  });
}

/* UPLOAD */
function abrirUpload(){
  document.getElementById("popupUpload").style.display="flex";
}
function fecharUpload(){
  document.getElementById("popupUpload").style.display="none";
}

function preencherDestinoUpload(){
  const select = document.getElementById("uploadDestino");
  select.innerHTML="";

  dados.filter(p=>p.tipo==="pasta").forEach(p=>{
    select.innerHTML += `<option value="${p.id}">${p.nome}</option>`;
  });
}

const drop = document.getElementById("dropArea");

drop.onclick = ()=> document.getElementById("uploadInput").click();
drop.ondragover = e=>{
  e.preventDefault();
  drop.classList.add("dragover");
};
drop.ondragleave = ()=> drop.classList.remove("dragover");
drop.ondrop = e=>{
  e.preventDefault();
  drop.classList.remove("dragover");
  enviarArquivos(e.dataTransfer.files);
};

function enviarUpload(){
  enviarArquivos(document.getElementById("uploadInput").files);
}

function enviarArquivos(files){
  const destino = document.getElementById("uploadDestino").value;

  [...files].forEach(file=>{
    const reader = new FileReader();

    reader.onload = ()=>{
      const base64 = reader.result.split(",")[1];

      fetch(API,{
        method:"POST",
        body:JSON.stringify({
          action:"upload",
          base64:base64,
          mime:file.type,
          nome:file.name,
          usuario:usuario,
          pai:destino
        })
      }).then(()=>carregar());
    };

    reader.readAsDataURL(file);
  });

  fecharUpload();
}

/* MODAL */
function abrirArquivo(nome,url){
  document.getElementById("modalTitulo").innerText = nome;
  document.getElementById("modalPreview").src = url;
  linkAtual = url;
  document.getElementById("modal").style.display="flex";
}

function fecharModal(){
  document.getElementById("modal").style.display="none";
}

function baixarArquivo(){
  let id = extrairID(linkAtual);
  if(!id) return;

  let linkDownload = "https://drive.google.com/uc?export=download&id=" + id;

  const a = document.createElement("a");
  a.href = linkDownload;
  a.download = "";
  document.body.appendChild(a);
  a.click();
  a.remove();
}

/* BUSCA */
function pesquisar(){
  const q = document.getElementById("busca").value.toLowerCase().trim();

  if(q === ""){
    mostrarPasta(pastaAtual);
    return;
  }

  const itens = dados.filter(p =>
    p.nome.toLowerCase().includes(q)
  );

  let html = "";

  itens.forEach(item=>{

    html += `
      <div class="item" onclick="${item.tipo==="pasta"
        ? `entrarPasta('${item.id}')`
        : `abrirArquivo('${item.nome}','${item.url}')`
      }">
        <div class="itemInner">
          ${item.tipo==="pasta" ? svgCor(item.capa) : gerarThumbnail(item.url,item.nome)}
          <div class="itemNome">${item.nome}</div>
        </div>
      </div>`;
  });

  document.getElementById("lista").innerHTML =
    html || "<div style='padding:20px;'>Nenhum resultado encontrado.</div>";

  document.getElementById("breadcrumbs").innerText = "üîç Resultados da busca";
}

/* EXCLUIR */
async function excluirArquivo() {
  if (!confirm("Tem certeza que deseja excluir este arquivo?")) return;

  let nome = document.getElementById("modalTitulo").innerText;
  let url = linkAtual;

  await fetch(API, {
    method: "POST",
    body: JSON.stringify({
      action: "excluir",
      nome: nome,
      url: url,
      usuario: usuario
    })
  });

  fecharModal();
  carregar();
}

</script>

</body>
</html>
