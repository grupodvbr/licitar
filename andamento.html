<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Acompanhamento de Processos â€¢ LICITAR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --azul:#0b1e39;
  --azul-claro:#2d6cdf;
  --azul-light:#8bb3ff;
  --bg:#eef2f7;
  --card:#ffffff;
  --shadow:0 10px 30px rgba(0,0,0,0.12);
  --radius:20px;
}

body{
  margin:0;
  padding:0;
  background:var(--bg);
  font-family:'Inter',sans-serif;
}

/* LOADING */
#overlay{
  position:fixed;
  top:0;left:0;width:100%;height:100%;
  background:rgba(255,255,255,0.9);
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:9999;
  font-size:25px;
  color:var(--azul);
  font-weight:600;
}

/* CONTAINER */
.container{ padding:25px; }

/* TITULO */
h1{
  text-align:center;
  color:var(--azul);
  margin-bottom:35px;
}

/* CARD */
.card{
  background:white;
  border-radius:var(--radius);
  padding:25px;
  box-shadow:var(--shadow);
  margin-bottom:30px;
}

/* ======================== TIMELINE ======================= */
.timeline{
  width:100%;
  margin:25px 0;
  position:relative;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.line{
  position:absolute;
  top:22px;
  left:0;
  height:6px;
  width:100%;
  background:#dce4ff;
  border-radius:4px;
  z-index:1;
}

/* NOVA LÃ“GICA: trecho final = 25% da barra */
.progress-line{
  position:absolute;
  top:22px;
  left:50%; /* inicia APENAS na 3Âª bolinha */
  height:6px;
  width:0%;
  background:linear-gradient(90deg,var(--azul-light),var(--azul-claro));
  border-radius:4px;
  transition:.4s;
  z-index:2;
}

.percent{
  position:absolute;
  font-size:12px;
  background:var(--azul);
  color:white;
  padding:4px 8px;
  border-radius:8px;
  font-weight:700;
  top:-25px;
  transform:translateX(-50%);
}

/* CIRCULOS */
.step{
  width:25%;
  text-align:center;
  z-index:3;
}

.circle{
  width:45px;
  height:45px;
  background:#d7e1ff;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  color:white;
  margin:0 auto;
}

.step.active .circle{
  background:var(--azul-claro);
}

.step span{
  font-size:13px;
  margin-top:5px;
  display:block;
  color:#444;
}

.step.active span{ color:var(--azul); font-weight:600; }

/* TABELA */
table{
  width:100%;
  border-collapse:collapse;
}

th{
  background:var(--azul);
  color:white;
  padding:10px;
  font-size:14px;
}

td{
  padding:10px;
  border-bottom:1px solid #ddd;
  background:white;
  cursor:pointer;
}

td:hover{ background:#f5f7ff; }

/* POPUP */
#popup{
  position:fixed;
  top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.55);
  display:none;
  justify-content:center;
  align-items:center;
  padding:20px;
  z-index:99999;
}

.popup-box{
  background:white;
  width:100%;
  max-width:700px;
  max-height:85vh;
  overflow:auto;
  padding:20px;
  border-radius:15px;
  animation:fade .25s ease;
}

@keyframes fade{
  from{opacity:0;transform:scale(.85);}
  to{opacity:1;transform:scale(1);}
}

.btnFechar{
  margin-top:15px;
  padding:10px 15px;
  background:var(--azul);
  color:white;
  border:none;
  border-radius:8px;
  cursor:pointer;
}

.btnFechar:hover{ background:#072035; }
</style>
</head>

<body>

<div id="overlay">Carregando...</div>

<div class="container">
  <h1>Acompanhamento dos Processos</h1>
  <div id="cards"></div>
</div>

<!-- POPUP -->
<div id="popup">
  <div class="popup-box">
    <h2>Romaneios do Item</h2>
    <div id="popContent"></div>
    <button class="btnFechar" onclick="fecharPopup()">Fechar</button>
  </div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbyz86L3UfB61bZf3SoTxmCBG-CkPi5cSFvfcnbCDFUrkQkJIREMip5HH7pqu1S1y2t2/exec";

/* FECHAR POPUP */
function fecharPopup(){
  document.getElementById("popup").style.display = "none";
}

/* LOAD PRINCIPAL */
(async function(){

  const empresas = await (await fetch(`${API}?action=getEmpresas`)).json();
  const itens    = await (await fetch(`${API}?action=getItens&codigo=ALL`)).json();
  const remessas = await (await fetch(`${API}?action=listarRemessas`)).json();
  const faturado = await (await fetch(`${API}?action=listarFaturado`)).json();

  let html = "";

  for(let emp of empresas){

    const itensEmpresa = itens.filter(i => i.codigoLicitacao === emp.codigo);

    let totalItens = 0;
    let totalQtd = 0;

    itensEmpresa.forEach(i=>{
      totalItens += Number(i.quantMin)*Number(i.valorUnit);
      totalQtd += Number(i.quantMin);
    });

    /* ENTREGAS */
    const roms = remessas.filter(r => r.codigoLicitacao === emp.codigo);

    let totalEntregue = 0;

    roms.forEach(r=>{
      try{
        const j = JSON.parse(r.json);
        j.itens.forEach(i=> totalEntregue += Number(i.quant));
      }catch(e){}
    });

    const percentual = totalQtd > 0 ? (totalEntregue / totalQtd)*100 : 0;

    /* STATUS */
    const iniciou = itensEmpresa.length > 0;
    const s2 = totalItens > 0;
    const s3 = percentual > 0;
    const fat = faturado.find(f => f.romaneioID === (roms[0]?.romaneioID || ""));
    const s4 = fat?.status === "RECEBIDO";

    /* ðŸŸ¦ BARRA AJUSTADA */
    const barraFinal = Math.min(percentual,100);
    const width = barraFinal/100 * 25; /* trecho final = 25% */
    const px = `calc(${width}% )`;

    html += `
    <div class="card">

      <h2>${emp.nome}</h2>
      <p><b>CNPJ:</b> ${emp.cnpj}</p>
      <p><b>Valor total:</b> R$ ${totalItens.toLocaleString("pt-BR",{minimumFractionDigits:2})}</p>

      <div class="timeline">
        <div class="line"></div>

        <div class="progress-line" style="width:${px};">
          <span class="percent" style="left:100%;">${percentual.toFixed(2)}%</span>
        </div>

        <div class="step ${iniciou?'active':''}">
          <div class="circle">âœ”</div>
          <span>Iniciado</span>
        </div>

        <div class="step ${s2?'active':''}">
          <div class="circle">âœ”</div>
          <span>Em anÃ¡lise</span>
        </div>

        <div class="step ${s3?'active':''}">
          <div class="circle">âœ”</div>
          <span>Em entrega</span>
        </div>

        <div class="step ${s4?'active':''}">
          <div class="circle">âœ”</div>
          <span>ConcluÃ­do</span>
        </div>

      </div>

      <h3>Itens cadastrados</h3>

      <table>
        <thead>
        <tr>
          <th>TR</th>
          <th>DescriÃ§Ã£o</th>
          <th>Marca</th>
          <th>Qtd</th>
          <th>Valor Unit</th>
          <th>Total Item</th>
        </tr>
        </thead>
        <tbody>
          ${itensEmpresa.map(i=>{
            const tot = Number(i.quantMin)*Number(i.valorUnit);
            return `
            <tr onclick="abrirItem('${emp.codigo}','${i.itemTR}')">
              <td>${i.itemTR}</td>
              <td>${i.especificacao.substring(0,70)}...</td>
              <td>${i.marca}</td>
              <td>${i.quantMin}</td>
              <td>R$ ${Number(i.valorUnit).toLocaleString("pt-BR",{minimumFractionDigits:2})}</td>
              <td>R$ ${tot.toLocaleString("pt-BR",{minimumFractionDigits:2})}</td>
            </tr>`;
          }).join("")}
        </tbody>
      </table>

    </div>
    `;
  }

  document.getElementById("cards").innerHTML = html;
  document.getElementById("overlay").style.display = "none";

})();

/* POP-UP ROMANEIOS */
async function abrirItem(cod, tr){

  const remessas = await (await fetch(`${API}?action=listarRemessas`)).json();

  let lista = [];

  remessas.forEach(r=>{
    if(r.codigoLicitacao === cod){
      try{
        const j = JSON.parse(r.json);
        j.itens.forEach(i=>{
          if(String(i.itemTR) === String(tr)){
            lista.push({
              rom:r.romaneioID,
              data:r.data,
              quant:i.quant,
              total:i.quant * i.valorUnit
            });
          }
        });
      }catch(e){}
    }
  });

  let html="";

  if(lista.length===0){
    html="<p>Nenhuma entrega registrada para este item.</p>";
  }else{
    html = `
    <table>
    <thead>
      <tr><th>Romaneio</th><th>Data</th><th>Qtd</th><th>Total</th></tr>
    </thead>
    <tbody>
    ${lista.map(l=>`
      <tr>
        <td>${l.rom}</td>
        <td>${l.data}</td>
        <td>${l.quant}</td>
        <td>R$ ${l.total.toLocaleString("pt-BR",{minimumFractionDigits:2})}</td>
      </tr>`).join("")}
    </tbody>
    </table>`;
  }

  document.getElementById("popContent").innerHTML = html;
  document.getElementById("popup").style.display="flex";
}
</script>

</body>
</html>
