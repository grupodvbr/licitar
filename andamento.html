<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Acompanhamento de Processos ‚Ä¢ LICITAR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --azul:#0b1e39;
  --azul-claro:#2d6cdf;
  --azul-light:#95b9ff;
  --bg:#eef2f7;
  --card:#ffffff;
  --shadow:0 10px 30px rgba(0,0,0,0.12);
  --radius:20px;
}

body{
  margin:0;
  padding:0;
  background:var(--bg);
  font-family:'Inter',sans-serif;
}

/* LOADING */
#overlay{
  position:fixed;
  top:0;left:0;width:100%;height:100%;
  background:white;
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:9999;
  font-size:26px;
  color:var(--azul);
  font-weight:700;
}

/* CONTAINER */
.container{ padding:25px; }

/* TITULO */
h1{
  text-align:center;
  color:var(--azul);
  margin-bottom:35px;
}

/* CARD */
.card{
  background:white;
  border-radius:var(--radius);
  padding:25px;
  box-shadow:var(--shadow);
  margin-bottom:30px;
}

/* ======================== TIMELINE ======================= */
.timeline{
  position:relative;
  width:100%;
  margin:30px 0 25px 0;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.line{
  position:absolute;
  top:24px;
  left:0;
  height:6px;
  width:100%;
  background:#dce4ff;
  border-radius:4px;
  z-index:1;
}

/* Inicia em 50% (bolinha 3) */
.progress-line{
  position:absolute;
  top:24px;
  left:50%;
  height:6px;
  width:0%;
  background:linear-gradient(90deg,var(--azul-light),var(--azul-claro));
  border-radius:4px;
  z-index:2;
  transition:.4s;
}

/* Percentual acompanhando a barra */
.percent{
  position:absolute;
  top:-25px;
  background:var(--azul);
  color:white;
  padding:4px 8px;
  border-radius:8px;
  font-size:13px;
  font-weight:700;
  transform:translateX(-50%);
}

/* STEPS */
.step{
  width:25%;
  text-align:center;
  z-index:3;
}

.circle{
  width:45px;
  height:45px;
  background:#d7e1ff;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  color:white;
  margin:auto;
}

.step.active .circle{
  background:var(--azul-claro);
}

.step span{
  margin-top:6px;
  display:block;
  font-size:13px;
  color:#444;
}

.step.active span{
  color:var(--azul);
  font-weight:600;
}

/* TABELA */
table{
  width:100%;
  border-collapse:collapse;
}
th{
  background:var(--azul);
  color:white;
  padding:10px;
}
td{
  padding:10px;
  background:white;
  border-bottom:1px solid #ddd;
  cursor:pointer;
}
td:hover{ background:#f5f7ff; }

/* POPUP */
#popup{
  position:fixed;
  top:0;left:0;
  width:100%;height:100%;
  background:rgba(0,0,0,0.55);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:999999;
}
.popup-box{
  background:white;
  width:95%;
  max-width:650px;
  padding:20px;
  max-height:90vh;
  overflow:auto;
  border-radius:15px;
  animation:fade .25s ease;
}
@keyframes fade{
  from{opacity:0;transform:scale(.85);}
  to{opacity:1;transform:scale(1);}
}
.btnFechar{
  margin-top:15px;
  padding:10px 15px;
  background:var(--azul);
  color:white;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
</style>
</head>

<body>

<div id="overlay">Carregando...</div>

<div class="container">
  <h1>Acompanhamento dos Processos</h1>
  <div id="cards"></div>
</div>

<!-- POPUP -->
<div id="popup">
  <div class="popup-box">
    <h2>Romaneios do Item</h2>
    <div id="popContent"></div>
    <button class="btnFechar" onclick="document.getElementById('popup').style.display='none'">Fechar</button>
  </div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbyz86L3UfB61bZf3SoTxmCBG-CkPi5cSFvfcnbCDFUrkQkJIREMip5HH7pqu1S1y2t2/exec";

/* POPUP OPEN */
function abrirPopup(html){
    document.getElementById("popContent").innerHTML = html;
    document.getElementById("popup").style.display = "flex";
}

/* MAIN */
(async function(){

    const empresas = await (await fetch(`${API}?action=getEmpresas`)).json();
    const itens    = await (await fetch(`${API}?action=getItens&codigo=ALL`)).json();
    const remessas = await (await fetch(`${API}?action=listarRemessas`)).json();
    const faturado = await (await fetch(`${API}?action=listarFaturado`)).json();

    let html = "";

    for(let emp of empresas){

        const itensEmpresa = itens.filter(i => i.codigoLicitacao == emp.codigo);

        let totalQtd = itensEmpresa.reduce((s,i)=>s+Number(i.quantMin),0);
        let totalValor = itensEmpresa.reduce((s,i)=>s+(i.quantMin*i.valorUnit),0);

        /* üîµ CONTAR APENAS ENTREGAS COM STATUS RECEBIDO */
        let entregues = 0;

        remessas.forEach(r=>{
            const fat = faturado.find(f=>f.romaneioID == r.romaneioID);
            if(!fat || fat.status !== "RECEBIDO") return; // IGNORA PENDENTES
            
            try{
                JSON.parse(r.json).itens.forEach(it=>{
                    entregues += Number(it.quant);
                });
            }catch(e){}
        });

        const percentual = totalQtd ? (entregues/totalQtd)*100 : 0;

        /* STATUS */
        const iniciou = itensEmpresa.length > 0;
        const s2 = iniciou;
        const s3 = percentual > 0;
        const s4 = percentual >= 100;

        /* BARRA ENTREGA ‚Üí CONCLU√çDO (25% do total) */
        const width = (percentual * 0.25);  
        const left  = 50 + width;

        html += `
        <div class="card">

            <h2>${emp.nome}</h2>
            <p><b>CNPJ:</b> ${emp.cnpj}</p>
            <p><b>Valor total:</b> R$ ${totalValor.toLocaleString("pt-BR",{minimumFractionDigits:2})}</p>

            <div class="timeline">
                <div class="line"></div>

                <div class="progress-line" style="width:${width}%;"></div>
                <div class="percent" style="left:${left}%;${percentual<=0?'display:none':''}">${percentual.toFixed(2)}%</div>

                <div class="step ${iniciou?'active':''}">
                    <div class="circle">‚úî</div><span>Iniciado</span>
                </div>
                <div class="step ${s2?'active':''}">
                    <div class="circle">‚úî</div><span>Em an√°lise</span>
                </div>
                <div class="step ${s3?'active':''}">
                    <div class="circle">‚úî</div><span>Em entrega</span>
                </div>
                <div class="step ${s4?'active':''}">
                    <div class="circle">‚úî</div><span>Conclu√≠do</span>
                </div>
            </div>

            <h3>Itens cadastrados</h3>
            <table>
                <thead>
                  <tr><th>TR</th><th>Descri√ß√£o</th><th>Marca</th><th>Qtd</th><th>Unit</th><th>Total</th></tr>
                </thead>
                <tbody>
                ${itensEmpresa.map(i=>{
                    const tot = i.quantMin * i.valorUnit;
                    return `
                        <tr onclick="mostrarRomaneios('${emp.codigo}','${i.itemTR}')">
                            <td>${i.itemTR}</td>
                            <td>${i.especificacao.substring(0,80)}...</td>
                            <td>${i.marca}</td>
                            <td>${i.quantMin}</td>
                            <td>R$ ${i.valorUnit.toLocaleString("pt-BR",{minimumFractionDigits:2})}</td>
                            <td>R$ ${tot.toLocaleString("pt-BR",{minimumFractionDigits:2})}</td>
                        </tr>`;
                }).join("")}
                </tbody>
            </table>

        </div>
        `;
    }

    document.getElementById("cards").innerHTML = html;
    document.getElementById("overlay").style.display = "none";

})();

/* POPUP ROMANEIOS */
async function mostrarRomaneios(cod,tr){

    const rem = await (await fetch(`${API}?action=listarRemessas`)).json();

    let lista = [];

    rem.forEach(r=>{
        try{
            JSON.parse(r.json).itens.forEach(it=>{
                if(it.itemTR == tr){
                    lista.push({
                        id:r.romaneioID,
                        data:r.data,
                        qtd:it.quant,
                        total:it.quant*it.valorUnit
                    });
                }
            });
        }catch(e){}
    });

    let html="";

    if(lista.length===0){
        html="<p>Nenhum romaneio registrado para este item.</p>";
    }else{
        html=`<table>
                <thead><tr><th>ID</th><th>Data</th><th>Qtd</th><th>Total</th></tr></thead>
                <tbody>
                ${lista.map(l=>`
                    <tr>
                      <td>${l.id}</td>
                      <td>${l.data}</td>
                      <td>${l.qtd}</td>
                      <td>R$ ${l.total.toLocaleString("pt-BR",{minimumFractionDigits:2})}</td>
                    </tr>
                `).join("")}
                </tbody>
              </table>`;
    }

    abrirPopup(html);
}
</script>

</body>
</html>
