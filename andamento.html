<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Acompanhamento de Processos • LICITAR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --azul:#0b1e39;
  --azul-claro:#2d6cdf;
  --azul-light:#7aa8ff;
  --bg:#eef2f7;
  --card:#ffffff;
  --shadow:0 10px 30px rgba(0,0,0,0.12);
  --radius:20px;
}

body{
  margin:0;
  padding:20px;
  background:var(--bg);
  font-family:'Inter',sans-serif;
}

h1{
  text-align:center;
  color:var(--azul);
  margin-bottom:35px;
  font-size:30px;
}

/* CARD */
.card{
  background:white;
  border-radius:var(--radius);
  padding:25px;
  box-shadow:var(--shadow);
  margin-bottom:30px;
}

/* TIMELINE */
.timeline{
  width:100%;
  margin:25px 0 15px 0;
  position:relative;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.line{
  position:absolute;
  top:22px;
  left:0;
  height:6px;
  width:100%;
  background:#dce4ff;
  z-index:1;
  border-radius:4px;
}

/* ==== SOMENTE ENTREGA → CONCLUÍDO ==== */
.progress-entrega{
  position:absolute;
  top:22px;
  height:6px;
  background:linear-gradient(90deg,var(--azul-light),var(--azul-claro));
  z-index:2;
  border-radius:4px;
  transition:.4s;
}

/* STEPS */
.step{
  z-index:3;
  text-align:center;
  width:25%;
}

.circle{
  width:45px;
  height:45px;
  margin:0 auto;
  background:#d7e1ff;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  color:white;
  transition:.3s;
}

.step.active .circle{
  background:var(--azul-claro);
}

.step span{
  display:block;
  margin-top:6px;
  font-size:13px;
  color:#444;
}

.step.active span{
  font-weight:600;
  color:var(--azul);
}

/* PERCENTUAL */
.percent{
  text-align:center;
  font-weight:700;
  margin-top:-10px;
  margin-bottom:10px;
  color:var(--azul);
}

/* TABELAS */
table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}

th{
  background:var(--azul);
  color:white;
  padding:10px;
  font-size:14px;
}

td{
  background:white;
  padding:10px;
  border-bottom:1px solid #ddd;
  font-size:14px;
}
</style>
</head>

<body>

<h1>Acompanhamento dos Processos</h1>

<div id="cards"></div>

<script>
const API = "https://script.google.com/macros/s/AKfycbyz86L3UfB61bZf3SoTxmCBG-CkPi5cSFvfcnbCDFUrkQkJIREMip5HH7pqu1S1y2t2/exec";

(async function(){

  const empresas  = await fetch(`${API}?action=getEmpresas`).then(r=>r.json());
  const itens     = await fetch(`${API}?action=getItens&codigo=ALL`).then(r=>r.json());
  const remessas  = await fetch(`${API}?action=listarRemessas`).then(r=>r.json());
  const faturado  = await fetch(`${API}?action=listarFaturado`).then(r=>r.json());

  let html = "";

  empresas.forEach(emp=>{

    const itensEmpresa = itens.filter(i => i.codigoLicitacao === emp.codigo);

    const iniciou = itensEmpresa.length > 0;

    // TOTAL
    let totalItens = 0;
    let totalQtd = 0;

    itensEmpresa.forEach(i=>{
      totalItens += Number(i.quantMin) * Number(i.valorUnit);
      totalQtd    += Number(i.quantMin);
    });

    // REMESSAS
    const rom = remessas.filter(r => r.codigoLicitacao === emp.codigo);

    // TOTAL ENTREGUE
    let totalEntregue = 0;

    rom.forEach(r=>{
      try{
        const js = JSON.parse(r.json);
        js.itens.forEach(it=>{
          totalEntregue += Number(it.quant);
        });
      }catch(e){}
    });

    // PERCENTUAL
    const percentual = totalQtd > 0 ? (totalEntregue / totalQtd) * 100 : 0;

    const s2 = totalItens > 0;
    const s3 = percentual > 0;

    const fat = faturado.find(f => f.romaneioID === (rom[0]?.romaneioID || ""));
    const s4 = fat?.status === "RECEBIDO";

    // POSIÇÃO DA BARRA ENTREGA → CONCLUÍDO
    const larguraSegmento = 100 / 3; // cada trecho

    // INÍCIO DO SEGMENTO 3
    const inicioEntrega = larguraSegmento * 2;

    const larguraBarra = (percentual / 100) * larguraSegmento;

    html += `
    <div class="card">

      <h2>${emp.nome}</h2>
      <p><b>CNPJ:</b> ${emp.cnpj}</p>
      <p><b>Valor total:</b> R$ ${totalItens.toLocaleString("pt-BR",{minimumFractionDigits:2})}</p>

      <div class="percent">${percentual.toFixed(2)}% entregue</div>

      <div class="timeline">

        <div class="line"></div>

        <!-- BARRA APENAS ENTRE ENTREGA → CONCLUÍDO -->
        <div class="progress-entrega"
             style="
               left:${inicioEntrega}%;
               width:${larguraBarra}%;
             ">
        </div>

        <div class="step ${iniciou ? 'active':''}">
          <div class="circle">✔</div>
          <span>Iniciado</span>
        </div>

        <div class="step ${s2 ? 'active':''}">
          <div class="circle">✔</div>
          <span>Em análise</span>
        </div>

        <div class="step ${s3 ? 'active':''}">
          <div class="circle">✔</div>
          <span>Em entrega</span>
        </div>

        <div class="step ${s4 ? 'active':''}">
          <div class="circle">✔</div>
          <span>Concluído</span>
        </div>

      </div>

      <h3>Itens cadastrados</h3>
      <table>
        <thead>
          <tr>
            <th>TR</th>
            <th>Descrição</th>
            <th>Marca</th>
            <th>Qtd</th>
            <th>Valor Unit</th>
            <th>Total Item</th>
          </tr>
        </thead>
        <tbody>
        ${
          itensEmpresa.map(i=>{
            const totalItem = Number(i.quantMin) * Number(i.valorUnit);
            return `
              <tr>
                <td>${i.itemTR}</td>
                <td>${i.especificacao.substring(0,70)}...</td>
                <td>${i.marca}</td>
                <td>${i.quantMin}</td>
                <td>R$ ${Number(i.valorUnit).toLocaleString("pt-BR",{minimumFractionDigits:2})}</td>
                <td>R$ ${totalItem.toLocaleString("pt-BR",{minimumFractionDigits:2})}</td>
              </tr>
            `;
          }).join("")
        }
        </tbody>
      </table>

    </div>
    `;
  });

  document.getElementById("cards").innerHTML = html;

})();
</script>

</body>
</html>
