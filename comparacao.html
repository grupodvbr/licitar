<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Comparador de Pre√ßos</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
body {
  font-family: 'Inter', sans-serif;
  background: #f9fafb;
  margin: 0; padding: 20px;
}
h1 {
  text-align: center;
  color: #222;
}
#busca {
  width: 100%;
  max-width: 450px;
  display: block;
  margin: 10px auto 20px;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-size: 15px;
}
#btnVoltar {
  display: none;
  margin: 0 auto 20px;
  background: #222;
  color: #fff;
  border: none;
  padding: 8px 18px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
}
#btnVoltar:hover { background: #444; }

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}
th, td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: left;
  font-size: 14px;
}
th { background: #222; color: #fff; }
tr:nth-child(even) { background: #f1f1f1; }
tr:hover { background: #e9e9e9; cursor: pointer; }
tr.menor { background: #c6f6d5; font-weight: 600; }
.loader { text-align: center; margin-top: 50px; }
thead tr th { position: sticky; top: 0; z-index: 10; }

/* ===== MODAL ===== */
.modal {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  justify-content: center;
  align-items: center;
  z-index: 999;
}
.modal-content {
  background: #fff;
  border-radius: 12px;
  padding: 20px;
  width: 90%;
  max-width: 800px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  max-height: 85vh;
  overflow-y: auto;
  animation: fadeIn 0.3s ease;
}
@keyframes fadeIn { from {opacity:0; transform:scale(0.95);} to {opacity:1; transform:scale(1);} }
.close-btn {
  background: #ff5555;
  color: #fff;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
}
.close-btn:hover { background: #ff3333; }
</style>
</head>
<body>

<h1>COTA√á√ÉO DE PRODUTOS</h1>
<input id="busca" type="text" placeholder="üîç Buscar produto e compare fornecedores..." onkeyup="buscarGlobal()">
<button id="btnVoltar" onclick="voltarComparativo()">‚¨Ö Voltar ao Comparativo</button>
<div id="tabela"></div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="modal-content" id="modalBox">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2 id="modalTitulo"></h2>
      <button class="close-btn" onclick="fecharModal()">Fechar</button>
    </div>
    <div id="modalConteudo"></div>
  </div>
</div>

<script>
const BASE_URL = "https://script.google.com/macros/s/AKfycbwkiy4-Pr5cjNROUYmickCcW9zIpEuZ63uFepyvLft0dloNJsaCmRiAMWIg6t-qEgKgGw/exec";

async function carregarComparativo() {
  document.getElementById('tabela').innerHTML = '<div class="loader">‚è≥ Carregando comparativo...</div>';
  const btn = document.getElementById('btnVoltar'); btn.style.display = "none";

  try {
    const res = await fetch(`${BASE_URL}?action=comparar`);
    const data = await res.json();
    renderComparativo(data);
  } catch (err) {
    document.getElementById('tabela').innerHTML = `<p>Erro: ${err.message}</p>`;
  }
}

function renderComparativo(data) {
  const div = document.getElementById('tabela');
  if (!data.length) return div.innerHTML = "<p>Nenhum resultado encontrado.</p>";

  let html = `<table><thead><tr>
    <th>Produto</th><th>Unidade</th><th>Qtd</th><th>Loja</th><th>Fornecedor Mais Barato</th><th>Valor Unit√°rio</th>
  </tr></thead><tbody>`;

  data.forEach((item, i) => {
    html += `<tr class="menor" onclick="abrirModal(${i})">
      <td>${item.produto}</td><td>${item.unidade}</td><td>${item.quantidade}</td>
      <td>${item.loja}</td><td>${item.fornecedor_mais_barato}</td>
      <td>R$ ${(item.valor_unitario||0).toFixed(2)}</td>
    </tr>`;
  });

  html += "</tbody></table>";
  div.innerHTML = html;
  window.todosDados = data;
}

let ultimaPesquisa = "";
async function buscarGlobal() {
  const campo = document.getElementById('busca');
  const termo = campo.value.trim().toLowerCase();
  if (termo === "") return carregarComparativo();
  if (termo === ultimaPesquisa) return;
  ultimaPesquisa = termo;

  document.getElementById('tabela').innerHTML = '<div class="loader">üîé Buscando...</div>';
  document.getElementById('btnVoltar').style.display = "inline-block";

  try {
    const res = await fetch(`${BASE_URL}?buscar=${encodeURIComponent(termo)}`);
    let data = await res.json();
    data.sort((a,b)=>(a.valor_unitario||0)-(b.valor_unitario||0));
    let html = `<table><thead><tr>
      <th>Loja</th><th>Fornecedor</th><th>Descri√ß√£o</th><th>Valor Unit√°rio</th></tr></thead><tbody>`;
    data.forEach(i=>{
      html+=`<tr><td>${i.loja}</td><td>${i.fornecedor}</td><td>${i.descricao}</td><td>R$ ${(i.valor_unitario||0).toFixed(2)}</td></tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('tabela').innerHTML = html;
  } catch(e){
    document.getElementById('tabela').innerHTML = `<p>Erro: ${e.message}</p>`;
  }
}

function voltarComparativo(){
  document.getElementById('busca').value = '';
  ultimaPesquisa = '';
  carregarComparativo();
}

function abrirModal(index){
  const item = window.todosDados[index];
  if(!item) return;
  const modal = document.getElementById('modal');
  const conteudo = document.getElementById('modalConteudo');
  document.getElementById('modalTitulo').textContent = item.produto.toUpperCase();

  let tabela = `<table style="width:100%;border-collapse:collapse;margin-top:10px;">
  <thead><tr style="background:#222;color:#fff;"><th>Loja</th><th>Fornecedor</th><th>Descri√ß√£o</th><th>Valor Unit√°rio</th><th>Valor Total</th></tr></thead><tbody>`;
  item.fornecedores.forEach(f=>{
    tabela += `<tr><td>${f.loja}</td><td>${f.fornecedor}</td><td>${f.descricaoItem}</td>
    <td>R$ ${(f.valorUnit||0).toFixed(2)}</td><td>R$ ${(f.valorTotal||0).toFixed(2)}</td></tr>`;
  });
  tabela += '</tbody></table>';
  conteudo.innerHTML = tabela;
  modal.style.display = 'flex';
}
function fecharModal(){ document.getElementById('modal').style.display='none'; }

carregarComparativo();
</script>
</body>
</html>
