<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Gerar Romaneio • LICITAR</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
  --azul:#0b1e39;
  --azul-claro:#152c4d;
  --dourado:#c9a86c;
  --bg:#eef2f7;
  --card:#ffffff;
  --radius:18px;
  --shadow:0 8px 28px rgba(0,0,0,0.12);
}

/* ===== BASE ===== */
body{
  margin:0;
  background:var(--bg);
  font-family:'Inter', sans-serif;
  overflow-x:hidden;
}

/* ===== OVERLAY ===== */
#overlayProcessando{
  position:fixed;
  inset:0;
  background:rgba(255,255,255,0.90);
  backdrop-filter:blur(4px);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:99999;
  font-size:28px;
  font-weight:700;
  color:var(--azul);
}

/* ===== TELA INICIAL ===== */
#telaInicial{
  padding:30px 30px 40px 90px;
}

#telaInicial h1{
  text-align:left;
  color:var(--azul);
  margin-bottom:25px;
  font-size:32px;
  font-weight:800;
}

#busca{
  width:100%;
  max-width:450px;
  display:block;
  margin-bottom:25px;
  padding:15px 18px;
  border:1px solid #ccc;
  border-radius:14px;
  font-size:16px;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:22px;
}

.card{
  background:white;
  padding:25px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  cursor:pointer;
  transition:.25s;
  text-align:center;
}
.card:hover{ transform:translateY(-6px); }
.card h2{
  margin:0;
  font-size:22px;
  color:var(--azul);
}
.card small{
  margin-top:8px;
  display:block;
  color:#666;
}

/* ===== TELA EMPRESA ===== */
#telaEmpresa{
  display:none;
  min-height:100vh;
  padding-left:90px;
  background:#fff;
}

.topoEmpresa{
  background:var(--azul);
  color:white;
  padding:15px 20px;
  display:flex;
  align-items:center;
  gap:15px;
  font-size:20px;
  font-weight:600;
  position:sticky;
  top:0;
  z-index:50;
}
.topoEmpresa span{
  cursor:pointer;
  font-size:26px;
}

.boxEmpresa{
  background:white;
  padding:22px;
  margin:20px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
}

/* ===== TABELA ===== */
.boxItens{
  padding:20px;
}

table{
  width:100%;
  border-collapse:collapse;
  background:white;
  border-radius:var(--radius);
  overflow:hidden;
  box-shadow:var(--shadow);
}

th,td{
  padding:10px;
  border-bottom:1px solid #eee;
  font-size:14px;
}
th{
  background:var(--azul);
  color:white;
}

/* ===== BOTÕES ===== */
.btn{
  margin-top:10px;
  background:var(--dourado);
  border:none;
  padding:14px 20px;
  font-size:16px;
  border-radius:14px;
  cursor:pointer;
  font-weight:700;
}
.btn:hover{ background:#b4904f; }

/* ===== POPUP ===== */
#popup{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:20000;
}
.popup{
  background:white;
  width:90%;
  max-width:480px;
  padding:25px;
  border-radius:20px;
  box-shadow:var(--shadow);
}

#finalizadoBox{
  display:none;
  padding:30px;
  text-align:center;
}
</style>
</head>

<body>

<div id="overlayProcessando">Processando...</div>

<!-- ================== TELA INICIAL ================== -->
<div id="telaInicial">
  <h1>Gerar Romaneio</h1>

  <input id="busca" placeholder="Pesquisar empresa..." onkeyup="filtrar()">
  <div id="listaCards" class="grid"></div>
</div>

<!-- ================== TELA EMPRESA ================== -->
<div id="telaEmpresa">

  <div class="topoEmpresa">
    <span onclick="voltarTela()">←</span>
    <div id="nomeTopo"></div>
  </div>

  <div id="boxEmpresa" class="boxEmpresa"></div>

  <div class="boxItens">
    <h2 style="color:var(--azul); margin:10px 0 15px;">Itens da Licitação</h2>

    <table>
      <thead>
        <tr>
          <th>TR</th>
          <th>Descrição</th>
          <th>Marca</th>
          <th>Valor</th>
          <th>Mín</th>
          <th>Enviados</th>
          <th>Disp</th>
          <th>Fornecedor</th>
          <th>Qtd</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="tbodyItens"></tbody>
    </table>

    <button class="btn" onclick="mostrarResumo()">Gerar Romaneio</button>
  </div>

  <div id="finalizadoBox">
    <h2 style="color:var(--azul);font-weight:800;">Romaneio Gerado ✔</h2>
    <button class="btn" onclick="location.href='romaneios.html'">Ver Romaneios</button>
  </div>
</div>

<!-- ================== POPUP ================== -->
<div id="popup">
  <div class="popup">
    <h3 style="color:var(--azul)">Resumo do Romaneio</h3>
    <div id="resumo"></div>
    <br>
    <button class="btn" onclick="confirmar()">Confirmar</button>
    <button class="btn" style="background:#777;color:white;" onclick="fecharPopup()">Cancelar</button>
  </div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbwWCffA5d3VdVKlwAVlS159O5NlHRWlp4W2qldXnuDg2--LkOXv9L46bCPMCRNOWLXq/exec";

let codigoSelecionado = "";
let itensList = [];
let fornecedores = [];
let remessas = [];

/* MONEY */
function money(v){
  return Number(v).toLocaleString("pt-BR",{minimumFractionDigits:2});
}

/* ================== CARREGAR CARDS ================== */
async function carregar(){
  const empresas = await fetch(`${API}?action=getEmpresas`).then(r=>r.json());
  let html = "";
  empresas.forEach(e=>{
    html += `
      <div class="card" onclick="abrirEmpresa('${e.codigo}')">
        <h2>${e.nome}</h2>
        <small>${e.cnpj}</small>
      </div>`;
  });
  listaCards.innerHTML = html;
}
carregar();

/* FILTRAR */
function filtrar(){
  const termo = busca.value.toLowerCase();
  document.querySelectorAll(".card").forEach(c=>{
    c.style.display = c.innerText.toLowerCase().includes(termo) ? "block" : "none";
  });
}

/* ================== ABRIR EMPRESA ================== */
async function abrirEmpresa(cod){
  codigoSelecionado = cod;

  overlayProcessando.style.display = "flex";

  const emp = await fetch(`${API}?action=getEmpresa&codigo=${cod}`).then(r=>r.json()).catch(()=>null);

  nomeTopo.innerText = emp?.nome || "Empresa";

  boxEmpresa.innerHTML = `
    <b>Instituição:</b> ${emp.instituicao || ""}<br>
    <b>CNPJ:</b> ${emp.cnpj || ""}<br>
    <b>UF:</b> ${emp.uf || ""}<br>
  `;

  await carregarItens(cod);

  telaInicial.style.display = "none";
  telaEmpresa.style.display = "block";

  overlayProcessando.style.display = "none";
}

/* VOLTAR */
function voltarTela(){
  telaEmpresa.style.display="none";
  telaInicial.style.display="block";
  finalizadoBox.style.display="none";
}

/* ================== CARREGAR ITENS ================== */
async function carregarItens(cod){

  fornecedores = await fetch(`${API}?action=getFornecedores`).then(r=>r.json());
  remessas   = await fetch(`${API}?action=listarRemessas`).then(r=>r.json());

  const itens = await fetch(`${API}?action=getItens&codigo=${cod}`).then(r=>r.json());

  itensList = itens.map(it=>{
    const enviados = calcularEnviados(cod, it.itemTR);
    return {
      ...it,
      enviados,
      disponivel: it.quantMin - enviados,
      fornecedor:"",
      qtd:0,
      subtotal:0
    };
  });

  montarTabela();
}

/* ================== CÁLCULO DE ENVIADOS ================== */
function calcularEnviados(cod, tr){
  let tot = 0;
  remessas.forEach(r=>{
    try{
      const js = JSON.parse(r.json);
      if(js.codigoLicitacao === cod){
        js.itens.forEach(x=>{
          if(x.itemTR === tr) tot += Number(x.quant);
        });
      }
    }catch(e){}
  });
  return tot;
}

/* ================== MONTAR TABELA ================== */
function montarTabela(){
  let html="";
  itensList.forEach((it,i)=>{

    let fornecedoresHTML = fornecedores
      .map(f=>`<option value="${f.nome}">${f.nome}</option>`)
      .join("");

    html += `
      <tr>
        <td>${it.itemTR}</td>
        <td>${it.especificacao.substring(0,50)}...</td>
        <td>${it.marca}</td>
        <td>R$ ${money(it.valorUnit)}</td>
        <td>${it.quantMin}</td>
        <td>${it.enviados}</td>
        <td>${it.disponivel}</td>
        <td>
          <select onchange="itensList[${i}].fornecedor=this.value">
            <option value="">Fornecedor</option>
            ${fornecedoresHTML}
          </select>
        </td>
        <td><input type="number" min="0" max="${it.disponivel}" onchange="setQtd(${i},this.value)"></td>
        <td id="t${i}">R$ 0,00</td>
      </tr>
    `;
  });

  tbodyItens.innerHTML = html;
}

function setQtd(i,v){
  v = Number(v||0);
  itensList[i].qtd = v;
  itensList[i].subtotal = v * itensList[i].valorUnit;
  document.getElementById("t"+i).innerText = "R$ "+money(itensList[i].subtotal);
}

/* ================== RESUMO ================== */
function mostrarResumo(){
  const sel = itensList.filter(i=>i.qtd>0 && i.fornecedor!="");
  if(sel.length===0) return alert("Selecione itens e fornecedores!");

  const total = sel.reduce((s,i)=>s+i.subtotal,0);

  resumo.innerHTML =
    sel.map(i=>`
      <p>
        <b>${i.itemTR}</b> — ${i.qtd} × R$ ${money(i.valorUnit)} =
        <b>R$ ${money(i.subtotal)}</b><br>
        Fornecedor: <b>${i.fornecedor}</b>
      </p>
    `).join("") +
    `<hr><h3>Total: R$ ${money(total)}</h3>`;

  popup.style.display = "flex";
}

function fecharPopup(){
  popup.style.display = "none";
}

/* ================== CONFIRMAR ================== */
async function confirmar(){

  popup.style.display="none";
  overlayProcessando.style.display="flex";

  const dados = {
    data: new Date().toISOString().slice(0,10),
    codigoLicitacao: codigoSelecionado,
    itens: itensList
      .filter(i=>i.qtd>0)
      .map(i=>({
        itemTR: i.itemTR,
        especificacao: i.especificacao,
        marca: i.marca,
        valorUnit: i.valorUnit,
        qtd: i.qtd,
        fornecedor: i.fornecedor,
        subtotal: i.subtotal
      }))
  };

  await fetch(`${API}?action=registrarRomaneio&data=${encodeURIComponent(JSON.stringify(dados))}`);

  overlayProcessando.style.display="none";

  finalizadoBox.style.display="block";
  window.scrollTo(0,document.body.scrollHeight);
}
</script>

</body>
</html>
