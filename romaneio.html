<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Gerar Romaneio • LICITAR</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --azul:#0b1e39;
  --azul-escuro:#091627;
  --dourado:#c9a86c;
  --bg:#eef2f7;
  --card:#ffffff;
  --radius:20px;
  --shadow:0 8px 25px rgba(0,0,0,0.15);
}

body{
  margin:0;
  padding:20px;
  background:var(--bg);
  font-family:'Inter', sans-serif;
}

/* Título */
h1{
  text-align:center;
  margin-bottom:25px;
  color:var(--azul);
  font-size:28px;
  font-weight:700;
}

/* Busca */
#busca{
  width:100%;
  max-width:420px;
  display:block;
  margin:0 auto 25px auto;
  padding:12px;
  border:1px solid #ccc;
  border-radius:12px;
  font-size:16px;
}

/* Grid */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(330px,1fr));
  gap:20px;
  margin-bottom:25px;
}

/* Card */
.card{
  background:white;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:18px;
  cursor:pointer;
  transition:.2s;
}
.card:hover{ transform:scale(1.02); }
.card.sel{
  border:3px solid var(--dourado);
  background:#fff8e0;
}
.card h2{
  margin:0;
  color:var(--azul);
  font-size:18px;
}
.card small{
  color:#555;
}

/* Box empresa */
#boxEmpresa{
  display:none;
  background:white;
  padding:20px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  margin-bottom:25px;
}

/* Itens */
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  border-bottom:1px solid #ddd;
  padding:8px;
}
th{
  background:var(--azul);
  color:white;
}

/* Botões */
.btn{
  background:var(--dourado);
  color:black;
  border:none;
  padding:14px 20px;
  border-radius:12px;
  cursor:pointer;
  font-size:15px;
  font-weight:600;
}
.btn:hover{ background:#b89554; }

/* Popup */
.overlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  justify-content:center;
  align-items:center;
}
.popup{
  background:white;
  width:100%;
  max-width:460px;
  padding:25px;
  border-radius:20px;
  box-shadow:var(--shadow);
}
</style>
</head>

<body>

<h1>Gerar Romaneio</h1>

<input id="busca" placeholder="Pesquisar..." onkeyup="filtrar()">

<div id="listaCards" class="grid"></div>

<div id="boxEmpresa"></div>

<div id="boxItens" style="display:none;">
  <h2 style="color:var(--azul);">Itens Disponíveis</h2>
  <table>
    <thead>
      <tr>
        <th>TR</th>
        <th>Descrição</th>
        <th>Marca</th>
        <th>Valor</th>
        <th>Mín</th>
        <th>Enviados</th>
        <th>Disp.</th>
        <th>Fornecedor</th>
        <th>Qtd</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody id="tbodyItens"></tbody>
  </table>

  <br>
  <button class="btn" onclick="mostrarResumo()">Gerar Romaneio</button>
</div>

<!-- POPUP -->
<div id="popup" class="overlay">
  <div class="popup">
    <h3 style="color:var(--azul); margin-top:0;">Resumo do Romaneio</h3>
    <div id="resumo"></div>
    <br>
    <button class="btn" onclick="confirmarRomaneio()">Confirmar</button>
    <button class="btn" style="background:#555;color:white;margin-top:10px;" onclick="fechar()">Cancelar</button>
  </div>
</div>


<script>
const API = "https://script.google.com/macros/s/AKfycbyz86L3UfB61bZf3SoTxmCBG-CkPi5cSFvfcnbCDFUrkQkJIREMip5HH7pqu1S1y2t2/exec";

/************************************************************
 * 1 — CARREGAR LISTA DE LICITAÇÕES
 ************************************************************/
async function carregar(){

  const itens = await fetch(`${API}?action=getItens&codigo=ALL`)
    .then(r=>r.json()).catch(()=>[]);

  const licitacoes = {};
  itens.forEach(i=> licitacoes[i.codigoLicitacao] = true);

  const lista = Object.keys(licitacoes).map(c=>({codigo:c}));

  montarCards(lista);
}

/************************************************************
 * 2 — MONTAR CARDS
 ************************************************************/
async function montarCards(lista){

  const dadosLic = await fetch(`${API}?action=getEmpresas`)
    .then(r=>r.json()).catch([]);

  let html="";

  lista.forEach(l=>{
    const info = dadosLic.find(x=>x.codigo === l.codigo.replace("LIC","EMP")) || {};

    html += `
      <div class="card" onclick="selecionar('${l.codigo}', this)">
        <h2>${l.codigo}</h2>
        <small>${info?.nome || ""}</small>
      </div>`;
  });

  document.getElementById("listaCards").innerHTML = html;
}

/************************************************************
 * 3 — FILTRAR
 ************************************************************/
function filtrar(){
  const termo = busca.value.toLowerCase();
  document.querySelectorAll(".card").forEach(c=>{
    c.style.display = c.innerText.toLowerCase().includes(termo) ? "block" : "none";
  });
}

/************************************************************
 * 4 — SELECIONAR LICITAÇÃO
 ************************************************************/
async function selecionar(cod, el){

  document.querySelectorAll(".card").forEach(c=>c.classList.remove("sel"));
  el.classList.add("sel");

  const emp = await fetch(`${API}?action=getEmpresa&codigo=${cod}`)
    .then(r=>r.json()).catch(()=>({}));

  boxEmpresa.style.display="block";
  boxEmpresa.innerHTML = `
    <h2>${emp.nome}</h2>
    <b>Instituição:</b> ${emp.instituicao}<br>
    <b>CNPJ:</b> ${emp.cnpj}<br>
    <b>UF:</b> ${emp.uf}<br>
  `;

  carregarItens(cod, emp);
}

/************************************************************
 * 5 — CARREGAR ITENS DA LICITAÇÃO
 ************************************************************/
let lista = [];
let fornecedores=[];
let remessas=[];

async function carregarItens(cod, emp){

  fornecedores = await fetch(`${API}?action=getFornecedores`)
    .then(r=>r.json()).catch(()=>[]);

  remessas = await fetch(`${API}?action=listarRemessas`)
    .then(r=>r.json()).catch(()=>[]);

  const itens = await fetch(`${API}?action=getItens&codigo=${cod}`)
    .then(r=>r.json()).catch(()=>[]);

  lista = itens.map(it=>{
    const enviados = getEnviados(cod, it.itemTR);
    const disp = Number(it.quantMin) - enviados;

    return {
      ...it,
      enviados,
      disponivel: disp,
      fornecedor:"",
      qtd:0,
      subtotal:0
    };
  });

  montarTabela();
  boxItens.style.display="block";
}

/************************************************************
 * 6 — CALCULAR ENVIADOS
 ************************************************************/
function getEnviados(cod, tr){
  let tot=0;
  remessas.forEach(r=>{
    try{
      const js = JSON.parse(r.json);
      if(js.codigoLicitacao == cod){
        js.itens.forEach(i=>{
          if(i.itemTR == tr){ tot += Number(i.quant); }
        });
      }
    }catch(e){}
  });
  return tot;
}

/************************************************************
 * 7 — TABELA
 ************************************************************/
function montarTabela(){
  let html="";
  lista.forEach((it,i)=>{

    let opts = `<select onchange="selForn(${i},this.value)">
      <option value="">Selecione</option>`;
    fornecedores.forEach(f=> opts+=`<option>${f.nome}</option>`);
    opts+="</select>";

    html += `
      <tr>
        <td>${it.itemTR}</td>
        <td>${it.especificacao.substring(0,50)}...</td>
        <td>${it.marca}</td>
        <td>R$ ${Number(it.valorUnit).toFixed(2)}</td>
        <td>${it.quantMin}</td>
        <td>${it.enviados}</td>
        <td>${it.disponivel}</td>
        <td>${opts}</td>
        <td><input type="number" min="0" max="${it.disponivel}" 
             style="width:70px;" onchange="selQtd(${i},this.value)"></td>
        <td id="tot${i}">R$ 0,00</td>
      </tr>`;
  });

  tbodyItens.innerHTML = html;
}

function selForn(i,v){ lista[i].fornecedor=v; }
function selQtd(i,v){
  v=Number(v);
  if(v>lista[i].disponivel) return alert("Maior que disponível!");
  lista[i].qtd=v;
  lista[i].subtotal=v*Number(lista[i].valorUnit);
  document.getElementById("tot"+i).innerHTML="R$ "+lista[i].subtotal.toFixed(2);
}

/************************************************************
 * 8 — RESUMO
 ************************************************************/
function mostrarResumo(){
  const sel = lista.filter(i=>i.qtd>0 && i.fornecedor!="");
  if(sel.length==0) return alert("Nenhum item selecionado!");

  let total = sel.reduce((s,i)=>s+i.subtotal,0);

  let html="";
  sel.forEach(i=>{
    html += `<p><b>${i.itemTR}</b> — ${i.qtd} x R$ ${i.valorUnit} = 
             <b>R$ ${i.subtotal.toFixed(2)}</b><br>
             Fornecedor: ${i.fornecedor}</p>`;
  });
  html += `<hr><h3>Total: R$ ${total.toFixed(2)}</h3>`;

  document.getElementById("resumo").innerHTML = html;
  popup.style.display="flex";
}

function fechar(){ popup.style.display="none"; }

/************************************************************
 * 9 — GERAR ROMANEIO (AJUSTADO PARA GET)
 ************************************************************/
async function confirmarRomaneio(){

  const conta = await fetch(`${API}?action=getContas`)
    .then(r=>r.json()).then(x=>x[0]).catch(()=>null);

  const cardSel = document.querySelector(".card.sel h2").innerText;

  const itensEnviar = lista.filter(i=>i.qtd>0).map(i=>({
    itemTR:i.itemTR,
    especificacao:i.especificacao,
    marca:i.marca,
    fornecedor:i.fornecedor,
    valorUnit:i.valorUnit,
    quant:i.qtd,
    total:i.subtotal
  }));

  let payload = {
    data: new Date().toISOString().slice(0,10),
    codigoLicitacao: cardSel,
    empresa: document.querySelector("#boxEmpresa h2").innerText,
    cnpj:"",
    itens: itensEnviar,
    dataPrevista: new Date().toISOString().slice(0,10),
    fornecedor: itensEnviar[0].fornecedor,
    contaBancaria: conta ? `${conta.banco} – Ag ${conta.agencia} – Cc ${conta.conta}` : ""
  };

  const resp = await fetch(
    `${API}?action=registrarRomaneio&data=${encodeURIComponent(JSON.stringify(payload))}`
  ).then(r=>r.json());

  alert("Romaneio gerado com sucesso!");
  location.reload();
}

/************************************************************
 * INICIAR
 ************************************************************/
carregar();
</script>

</body>
</html>
