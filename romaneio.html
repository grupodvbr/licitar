<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Gerar Romaneio • LICITAR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --azul:#0b1e39;
  --azul-claro:#15345c;
  --dourado:#c9a86c;
  --bg:#eef2f7;
  --card:#fff;
  --radius:16px;
  --shadow:0 8px 25px rgba(0,0,0,.15);
}

body{
  background:var(--bg);
  font-family:"Inter",sans-serif;
  margin:0; padding:20px;
}

h1{
  text-align:center;
  color:var(--azul);
  margin-bottom:25px;
}

select,input{
  padding:10px;
  border-radius:10px;
  border:1px solid #ccc;
}

.card{
  background:white;
  padding:20px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  margin-bottom:20px;
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
}

th,td{
  padding:10px;
  border-bottom:1px solid #eee;
  font-size:14px;
}

th{
  background:var(--azul);
  color:white;
}

.btn{
  padding:12px 20px;
  background:var(--dourado);
  color:black;
  font-weight:600;
  border:none;
  border-radius:10px;
  cursor:pointer;
}
.btn:hover{ background:#b89554; }

/* POPUP */
.overlay{
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,.55);
  display:none;
  justify-content:center;
  align-items:center;
}
.popup{
  background:white;
  padding:25px;
  width:100%;
  max-width:450px;
  border-radius:16px;
  box-shadow:var(--shadow);
  animation:fade .2s ease;
}
@keyframes fade{
  from{opacity:0; transform:scale(.85);}
  to{opacity:1; transform:scale(1);}
}
</style>
</head>

<body>
<h1>Gerar Romaneio</h1>

<div class="card">
  <label><b>Selecione a Licitação:</b></label>
  <select id="selectLic" onchange="carregarItens()">
    <option value="">Carregando...</option>
  </select>
</div>

<div class="card" id="boxItens" style="display:none;">
  <h2>Itens da Licitação</h2>
  <table>
    <thead>
      <tr>
        <th>Item</th>
        <th>Marca</th>
        <th>Valor</th>
        <th>Min</th>
        <th>Enviados</th>
        <th>Disp.</th>
        <th>Fornecedor</th>
        <th>Qtd</th>
        <th>Subtotal</th>
      </tr>
    </thead>
    <tbody id="tbodyItens"></tbody>
  </table>

  <button class="btn" onclick="abrirResumo()">Gerar Romaneio</button>
</div>

<!-- POPUP RESUMO -->
<div class="overlay" id="popup">
  <div class="popup" id="boxResumo">
    <h3>Resumo do Romaneio</h3>
    <div id="conteudoResumo" style="font-size:14px;"></div>
    <button class="btn" onclick="confirmarRomaneio()">Confirmar</button>
    <button class="btn" style="background:#555;color:white;margin-top:10px;" onclick="fecharPopup()">Cancelar</button>
  </div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbzBH4008kB4AoA6_WAyuiPrB-FTZJXa8KGywkBkbHEqXriX9BPRDFoAMiN4UObYdeC3/exec"; // substitua!!!

let listaItens = [];
let fornecedores = [];
let remessas = [];

/* ===========================
   CARREGAR LICITAÇÕES
=========================== */
async function carregarLicitacoes(){
  const resp = await fetch(`${API}?action=getItens&codigo=ALL`).catch(()=>[]);
  // vamos buscar apenas licitações com itens
  const rem = await fetch(`${API}?action=listarRemessas`).then(r=>r.json());
  remessas = rem;

  const itens = await fetch(`${API}?action=getItens&codigo=ALL`);
}

/* ===========================
   CARREGAR ITENS
=========================== */
async function carregarItens(){
  const cod = document.getElementById("selectLic").value;
  if(!cod) return;

  const itens = await fetch(`${API}?action=getItens&codigo=${cod}`).then(r=>r.json());
  const fornecedoresList = await fetch(`${API}?action=getFornecedores`).then(r=>r.json());
  fornecedores = fornecedoresList;

  // Remessas para calcular "enviados"
  remessas = await fetch(`${API}?action=listarRemessas`).then(r=>r.json());

  listaItens = itens.map(it=>{
    const enviados = calcularEnviados(cod, it.itemTR);
    const disponivel = Number(it.quantMin) - enviados;

    return {
      ...it,
      enviados,
      disponivel,
      subtotal: 0,
      fornecedor:"",
      quantSolicitada: 0
    };
  });

  montarTabela();
  document.getElementById("boxItens").style.display="block";
}

/* ===========================
   CALCULAR ENVIADOS (JSON)
=========================== */
function calcularEnviados(codLic, itemTR){
  let total = 0;

  remessas.forEach(r=>{
    try{
      const js = JSON.parse(r.json);
      if(js.codigoLicitacao === codLic){
        js.itens.forEach(i=>{
          if(Number(i.itemTR) === Number(itemTR)){
            total += Number(i.quant);
          }
        });
      }
    }catch(e){}
  });

  return total;
}

/* ===========================
   TABELA DE ITENS
=========================== */
function montarTabela(){
  let html="";

  listaItens.forEach((it,idx)=>{
    let fornecedoresHTML = `<select onchange="selecionarFornec(${idx},this.value)">
      <option value="">Selecione</option>`;

    fornecedores.forEach(f=>{
      fornecedoresHTML += `<option value="${f.nome}">${f.nome}</option>`;
    });
    fornecedoresHTML += "</select>";

    html += `
    <tr>
      <td>${it.itemTR}</td>
      <td>${it.marca}</td>
      <td>R$ ${Number(it.valorUnit).toFixed(2)}</td>
      <td>${it.quantMin}</td>
      <td>${it.enviados}</td>
      <td>${it.disponivel}</td>
      <td>${fornecedoresHTML}</td>
      <td><input type='number' min='0' max='${it.disponivel}'
           onchange="definirQtd(${idx},this.value)" style="width:70px;"></td>
      <td id="sub${idx}">R$ 0,00</td>
    </tr>`;
  });

  document.getElementById("tbodyItens").innerHTML = html;
}

function selecionarFornec(i,v){
  listaItens[i].fornecedor = v;
}

function definirQtd(i,v){
  v = Number(v);
  if(v > listaItens[i].disponivel){
    alert("Quantidade maior que o disponível!");
    return;
  }
  listaItens[i].quantSolicitada = v;
  listaItens[i].subtotal = v * Number(listaItens[i].valorUnit);
  document.getElementById("sub"+i).innerHTML = "R$ " + listaItens[i].subtotal.toFixed(2);
}

/* ===========================
   RESUMO DO ROMANEIO
=========================== */
function abrirResumo(){
  const selecionados = listaItens.filter(i=>i.quantSolicitada>0 && i.fornecedor!="");

  if(selecionados.length === 0){
    alert("Nenhum item selecionado!");
    return;
  }

  let total = selecionados.reduce((s,i)=>s+i.subtotal,0);

  let html="";
  selecionados.forEach(i=>{
    html += `
      <div><b>${i.itemTR}</b> — ${i.quantSolicitada} x R$ ${Number(i.valorUnit).toFixed(2)}  
      → <b>R$ ${i.subtotal.toFixed(2)}</b>  
      <br>Fornecedor: ${i.fornecedor}</div><br>`;
  });

  html += `<hr><h3>Total Geral: R$ ${total.toFixed(2)}</h3>`;

  document.getElementById("conteudoResumo").innerHTML = html;
  document.getElementById("popup").style.display="flex";
}

function fecharPopup(){ document.getElementById("popup").style.display="none"; }

/* ===========================
   CONFIRMAR E ENVIAR ROMANEIO
=========================== */
async function confirmarRomaneio(){
  const lic = document.getElementById("selectLic").value;
  const data = new Date().toISOString().split("T")[0];

  const itensEnviar = listaItens.filter(i=>i.quantSolicitada>0 && i.fornecedor!="")
    .map(i=>({
      itemTR:i.itemTR,
      especificacao:i.especificacao,
      marca:i.marca,
      fornecedor:i.fornecedor,
      valorUnit:i.valorUnit,
      quant:i.quantSolicitada,
      total:i.subtotal
    }));

  const totalGeral = itensEnviar.reduce((s,i)=>s+i.total,0);

  let payload = {
    data:data,
    codigoLicitacao:lic,
    empresa:"",
    cnpj:"",
    itens:itensEnviar,
    total:totalGeral,
    dataPrevista:data
  };

  const resp = await fetch(`${API}?action=registrarRomaneio`,{
    method:"POST",
    body:new URLSearchParams({data:JSON.stringify(payload)})
  }).then(r=>r.json());

  alert("Romaneio gerado com sucesso!");
  location.reload();
}

</script>

</body>
</html>
