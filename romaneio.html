<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Gerar Romaneio • LICITAR</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --azul:#0b1e39;
  --azul-escuro:#091627;
  --dourado:#c9a86c;
  --bg:#eef2f7;
  --card:#ffffff;
  --radius:20px;
  --shadow:0 8px 25px rgba(0,0,0,0.15);
}

body{
  margin:0;
  padding:20px;
  background:var(--bg);
  font-family:'Inter', sans-serif;
}

/* Título */
h1{
  text-align:center;
  margin-bottom:25px;
  color:var(--azul);
  font-size:28px;
  font-weight:700;
}

/* Campo de pesquisa */
#busca{
  width:100%;
  max-width:420px;
  margin:0 auto 25px auto;
  display:block;
  padding:12px;
  border-radius:12px;
  border:1px solid #ccc;
  font-size:16px;
}

/* Grid de cards */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(330px,1fr));
  gap:20px;
  margin-bottom:30px;
}

/* Card */
.card{
  background:var(--card);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:20px;
  cursor:pointer;
  transition:.2s;
}
.card:hover{
  transform:scale(1.02);
}
.card h2{
  margin:0 0 10px 0;
  color:var(--azul);
  font-size:18px;
}
.card small{
  color:#444;
}

/* Card selecionado */
.card.sel{
  border:3px solid var(--dourado);
  background:#fff9e6;
}

/* Box da instituição selecionada */
#boxEmpresa{
  display:none;
  background:white;
  padding:20px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  margin-bottom:25px;
}

/* Tabela de itens */
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  padding:10px;
  border-bottom:1px solid #ddd;
  font-size:14px;
}
th{
  background:var(--azul);
  color:white;
}

/* Botão */
.btn{
  background:var(--dourado);
  padding:14px 20px;
  border:none;
  border-radius:12px;
  cursor:pointer;
  font-size:16px;
  font-weight:600;
}
.btn:hover{
  background:#b89554;
}

/* Pop-up */
.overlay{
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,.55);
  display:none;
  justify-content:center;
  align-items:center;
}

.popup{
  background:white;
  width:100%;
  max-width:480px;
  padding:25px;
  border-radius:20px;
  box-shadow:var(--shadow);
  animation:fade .2s ease;
}

@keyframes fade{
  from{opacity:0; transform:scale(.85);}
  to{opacity:1; transform:scale(1);}
}
</style>
</head>

<body>

<h1>Gerar Romaneio</h1>

<!-- Busca -->
<input id="busca" placeholder="Pesquisar instituição..." onkeyup="filtrarCards()">

<!-- Grid de cards -->
<div id="listaCards" class="grid"></div>

<!-- Box empresa selecionada -->
<div id="boxEmpresa"></div>

<!-- Tabela de itens -->
<div id="boxItens" style="display:none;">
  <h2 style="color:var(--azul);">Itens Disponíveis</h2>
  <table>
    <thead>
      <tr>
        <th>TR</th>
        <th>Descrição</th>
        <th>Marca</th>
        <th>Valor</th>
        <th>Min</th>
        <th>Enviados</th>
        <th>Disp.</th>
        <th>Fornecedor</th>
        <th>Qtd</th>
        <th>Subtotal</th>
      </tr>
    </thead>
    <tbody id="tbodyItens"></tbody>
  </table>

  <br>
  <button class="btn" onclick="abrirResumo()">Gerar Romaneio</button>
</div>

<!-- POPUP -->
<div id="popup" class="overlay">
  <div class="popup">
    <h3 style="color:var(--azul);">Resumo do Romaneio</h3>
    <div id="conteudoResumo" style="font-size:15px;"></div>
    <br>
    <button class="btn" onclick="confirmarRomaneio()">Confirmar</button>
    <button class="btn" style="background:#666;color:white;margin-top:10px;" onclick="fecharPopup()">Cancelar</button>
  </div>
</div>


<script>
const API = "https://script.google.com/macros/s/AKfycbzNi5EcrhsvfvkEcplTdMiYgUvcsQk_dLc0sW8G8lgCEWV-xRP5DRtrK-rZxL41eGVR/exec"; // TROCAR AQUI

/* ===========================
   CARREGAR CARDS (LICITAÇÕES)
=========================== */
async function carregarLicitacoes(){
  const lista = await fetch(`${API}?action=listarRemessas`)
    .catch(()=>null);

  const licitacoes = await fetch(`${API}?action=getEmpresas`)
    .then(r=>r.json()).catch(()=>[]);

  const licSheet = await fetch(`${API}?action=getLicitacoes`)
    .then(r=>r.json()).catch(()=>[]);

  montarCards(licSheet);
}

/* ===========================
   MONTAR CARDS
=========================== */
function montarCards(lista){
  let html="";

  lista.forEach(l=>{
    html += `
      <div class="card" onclick="selecionarLic('${l.codigo}', this)">
        <h2>${l.instituicao}</h2>
        <small>Código: ${l.codigo}</small><br>
        <small>Status: ${l.status || "-"}</small>
      </div>
    `;
  });

  document.getElementById("listaCards").innerHTML = html;
}

/* ===========================
   FILTRAR CARDS
=========================== */
function filtrarCards(){
  let termo = document.getElementById("busca").value.toLowerCase();
  let cards = document.querySelectorAll("#listaCards .card");

  cards.forEach(c=>{
    let texto = c.innerText.toLowerCase();
    c.style.display = texto.includes(termo) ? "block" : "none";
  });
}

/* ===========================
   SELECIONAR LICITAÇÃO
=========================== */
let empresaSel = {};
async function selecionarLic(codigo, el){
  document.querySelectorAll(".card").forEach(c=>c.classList.remove("sel"));
  el.classList.add("sel");

  empresaSel = await fetch(`${API}?action=getEmpresa&codigo=${codigo}`)
    .then(r=>r.json()).catch(()=>null);

  document.getElementById("boxEmpresa").style.display="block";
  document.getElementById("boxEmpresa").innerHTML = `
    <h2 style="color:var(--azul);">${empresaSel.nome}</h2>
    <b>Código:</b> ${codigo}<br>
    <b>Instituição:</b> ${empresaSel.instituicao}<br>
    <b>CNPJ:</b> ${empresaSel.cnpj}<br>
    <b>UF:</b> ${empresaSel.uf}<br>
  `;

  carregarItens(codigo);
}

/* ===========================
   CARREGAR ITENS DA LICITAÇÃO
=========================== */
let listaItens=[];
let fornecedores=[];
let remessas=[];

async function carregarItens(codigo){

  fornecedores = await fetch(`${API}?action=getFornecedores`)
    .then(r=>r.json()).catch(()=>[]);

  remessas = await fetch(`${API}?action=listarRemessas`)
    .then(r=>r.json()).catch(()=>[]);

  const itens = await fetch(`${API}?action=getItens&codigo=${codigo}`)
    .then(r=>r.json()).catch(()=>[]);

  listaItens = itens.map(it=>{
    let enviados = calcularEnviados(codigo, it.itemTR);
    let disp = Number(it.quantMin) - enviados;

    return {
      ...it,
      enviados,
      disponivel:disp,
      fornecedor:"",
      quantSolicitada:0,
      subtotal:0
    };
  });

  montarItens();
  document.getElementById("boxItens").style.display="block";
}

/* ===========================
   CALCULAR QUANTIDADE ENVIADA
=========================== */
function calcularEnviados(cod,itemTR){
  let total=0;

  remessas.forEach(r=>{
    try{
      const js = JSON.parse(r.json);
      if(js.codigoLicitacao == cod){
        js.itens.forEach(i=>{
          if(i.itemTR == itemTR){
            total += Number(i.quant);
          }
        });
      }
    }catch(e){}
  });

  return total;
}

/* ===========================
   MONTAR TABELA DE ITENS
=========================== */
function montarItens(){
  let html="";

  listaItens.forEach((it,i)=>{

    let selects = `<select onchange="defFornecedor(${i},this.value)">
      <option value="">Selecione</option>`;
    fornecedores.forEach(f=>{
      selects += `<option value="${f.nome}">${f.nome}</option>`;
    });
    selects += "</select>";

    html += `
      <tr>
        <td>${it.itemTR}</td>
        <td>${it.especificacao.substring(0,50)}...</td>
        <td>${it.marca}</td>
        <td>R$ ${Number(it.valorUnit).toFixed(2)}</td>
        <td>${it.quantMin}</td>
        <td>${it.enviados}</td>
        <td>${it.disponivel}</td>

        <td>${selects}</td>

        <td><input type="number" min="0" max="${it.disponivel}" 
             style="width:70px;" onchange="defQtd(${i},this.value)">
        </td>

        <td id="sub${i}">R$ 0,00</td>
      </tr>
    `;
  });

  document.getElementById("tbodyItens").innerHTML = html;
}

function defFornecedor(i,v){ listaItens[i].fornecedor=v; }

function defQtd(i,v){
  v=Number(v);
  if(v > listaItens[i].disponivel){
    alert("Quantidade maior que disponível!");
    return;
  }
  listaItens[i].quantSolicitada=v;
  listaItens[i].subtotal=v*Number(listaItens[i].valorUnit);
  document.getElementById("sub"+i).innerHTML =
    "R$ "+listaItens[i].subtotal.toFixed(2);
}

/* ===========================
   POPUP DE RESUMO
=========================== */
function abrirResumo(){

  let sel = listaItens.filter(i=>i.quantSolicitada>0 && i.fornecedor!="");

  if(sel.length==0){
    alert("Nenhum item selecionado!");
    return;
  }

  let total = sel.reduce((s,i)=>s+i.subtotal,0);
  let html="";

  sel.forEach(i=>{
    html += `<div>
      <b>TR ${i.itemTR}</b> — ${i.quantSolicitada} x R$ ${Number(i.valorUnit).toFixed(2)}
      = <b>R$ ${i.subtotal.toFixed(2)}</b><br>
      Fornecedor: ${i.fornecedor}
      <br><br>
    </div>`;
  });

  html += `<hr><h3>Total: R$ ${total.toFixed(2)}</h3>`;

  document.getElementById("conteudoResumo").innerHTML = html;
  document.getElementById("popup").style.display="flex";
}

function fecharPopup(){
  document.getElementById("popup").style.display="none";
}

/* ===========================
   CONFIRMAR ROMANEIO
=========================== */
async function confirmarRomaneio(){

  let codigo = document.querySelector(".card.sel small").innerText.split(": ")[1];

  let itensEnviar = listaItens
    .filter(i=>i.quantSolicitada>0 && i.fornecedor!="")
    .map(i=>({
      itemTR:i.itemTR,
      especificacao:i.especificacao,
      marca:i.marca,
      fornecedor:i.fornecedor,
      valorUnit:i.valorUnit,
      quant:i.quantSolicitada,
      total:i.subtotal
    }));

  let total = itensEnviar.reduce((s,i)=>s+i.total,0);

  let payload = {
    data:new Date().toISOString().split("T")[0],
    codigoLicitacao:codigo,
    empresa:empresaSel.nome,
    cnpj:empresaSel.cnpj,
    itens:itensEnviar,
    total:total,
    dataPrevista:new Date().toISOString().split("T")[0]
  };

  const resp = await fetch(`${API}?action=registrarRomaneio`,{
    method:"POST",
    body:new URLSearchParams({data:JSON.stringify(payload)})
  }).then(r=>r.json());

  alert("Romaneio gerado com sucesso!");
  location.reload();
}

/* ===========================
   INICIAR
=========================== */
carregarLicitacoes();
</script>

</body>
</html>
