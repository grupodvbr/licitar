<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Gerar Romaneio • LICITAR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root {
  --azul:#0b1e39;
  --azul-claro:#15345c;
  --dourado:#c9a86c;
  --bg:#eef2f7;
  --card:#ffffff;
  --radius:16px;
  --shadow:0 10px 25px rgba(0,0,0,.15);
}

body {
  background:var(--bg);
  font-family:'Inter',sans-serif;
  padding:20px;
  margin:0;
}

h1 {
  color:var(--azul);
  text-align:center;
}

.container {
  max-width:900px;
  margin:auto;
  background:var(--card);
  padding:20px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
}

input, select {
  width:100%;
  padding:12px;
  margin-bottom:12px;
  border-radius:10px;
  border:1px solid #ccc;
  font-size:15px;
}

button {
  width:100%;
  padding:14px;
  background:var(--azul);
  color:white;
  border:none;
  border-radius:12px;
  font-size:16px;
  cursor:pointer;
  margin-top:10px;
}
button:hover {
  background:var(--azul-claro);
}

table {
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}
th, td {
  padding:10px;
  border-bottom:1px solid #ddd;
  font-size:14px;
}
th {
  background:var(--azul);
  color:white;
}

.totalBox {
  margin-top:20px;
  padding:15px;
  background:#fff7dd;
  border:2px solid var(--dourado);
  border-radius:10px;
  font-size:18px;
  font-weight:bold;
  text-align:right;
}

.resumoBox {
  background:white;
  padding:18px;
  margin-top:20px;
  border-radius:12px;
  box-shadow:var(--shadow);
}

.btnConfirmar {
  background:var(--dourado);
  color:black;
  font-weight:700;
}
.btnConfirmar:hover {
  background:#b89554;
}

.hidden {
  display:none;
}
</style>
</head>

<body>

<h1>Gerar Romaneio</h1>

<div class="container">

  <label>Código da Licitação:</label>
  <input id="codigoLicitacao" placeholder="Ex: LIC-0001" onblur="buscarEmpresa()">

  <div id="dadosEmp"></div>

  <div id="areaItens" class="hidden">
    <h3>Itens da Licitação</h3>
    <table>
      <thead>
        <tr>
          <th>Item</th>
          <th>Valor</th>
          <th>Qtd</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="listaItens"></tbody>
    </table>

    <div class="totalBox">Total: R$ <span id="somaTotal">0,00</span></div>

    <label>Fornecedor:</label>
    <select id="fornecedor"></select>

    <label>Conta Bancária:</label>
    <select id="conta"></select>

    <label>Data Prevista de Recebimento:</label>
    <input type="date" id="dataPrevista">

    <button onclick="mostrarResumo()">Avançar</button>
  </div>

  <div id="resumo" class="hidden"></div>

</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbzBH4008kB4AoA6_WAyuiPrB-FTZJXa8KGywkBkbHEqXriX9BPRDFoAMiN4UObYdeC3/exec"; // ⬅ troque

let empresa = null;
let itens = [];

/* ============================
   1 — BUSCA EMPRESA E ITENS
============================ */
async function buscarEmpresa(){
  let cod = document.getElementById("codigoLicitacao").value.trim();
  if(!cod) return;

  let emp = await fetch(`${API}?action=getEmpresa&codigo=${cod}`).then(r=>r.json());
  if(emp.erro){
    alert("Licitação não encontrada.");
    return;
  }

  empresa = emp;

  document.getElementById("dadosEmp").innerHTML = `
    <div style="background:#fff;padding:15px;border-radius:10px;margin:15px 0;border-left:6px solid var(--azul)">
      <b>Instituição:</b> ${emp.nome}<br>
      <b>CNPJ:</b> ${emp.cnpj}<br>
      <b>UF:</b> ${emp.uf}
    </div>
  `;

  await carregarItens(cod);
  await carregarSelects();

  document.getElementById("areaItens").classList.remove("hidden");
}

/* ============================
   2 — CARREGAR ITENS
============================ */
async function carregarItens(codigo){

  itens = await fetch(`${API}?action=getItens&codigo=${codigo}`).then(r=>r.json());

  let html = "";

  itens.forEach((i, idx)=>{
    html += `
      <tr>
        <td>${i.itemTR} - ${i.especificacao}</td>
        <td>R$ ${Number(i.valorUnit).toFixed(2)}</td>
        <td><input type="number" min="0" value="0" style="width:70px"
             onchange="atualizarQtd(${idx}, this.value)"></td>
        <td id="t${idx}">R$ 0,00</td>
      </tr>
    `;
  });

  document.getElementById("listaItens").innerHTML = html;
}

/* CALCULA QUANTIDADE */
function atualizarQtd(idx, qtd){
  qtd = Number(qtd);
  itens[idx].quant = qtd;
  itens[idx].total = qtd * Number(itens[idx].valorUnit);

  document.getElementById(`t${idx}`).innerHTML = 
      "R$ " + itens[idx].total.toFixed(2);

  atualizarTotal();
}

/* TOTAL GERAL */
function atualizarTotal(){
  let soma = itens.reduce((s,i)=>s+(i.total||0),0);
  document.getElementById("somaTotal").innerHTML = soma.toFixed(2);
}

/* ============================
   3 — CARREGAR FORNECEDORES E CONTAS
============================ */
async function carregarSelects(){
  let fornecedores = await fetch(`${API}?action=getFornecedores`).then(r=>r.json());
  let contas = await fetch(`${API}?action=getContas`).then(r=>r.json());

  document.getElementById("fornecedor").innerHTML =
    fornecedores.map(f=>`<option value="${f.nome}">${f.nome}</option>`).join("");

  document.getElementById("conta").innerHTML =
    contas.map(c=>`<option value="${c.banco} – Ag ${c.agencia} – Cc ${c.conta}">${c.banco} – Ag ${c.agencia} – Cc ${c.conta}</option>`).join("");
}

/* ============================
   4 — RESUMO FINAL
============================ */
function mostrarResumo(){
  let dataPrev = document.getElementById("dataPrevista").value;

  let lista = itens.filter(i=>i.quant>0);

  if(lista.length === 0){
    alert("Selecione ao menos 1 item.");
    return;
  }

  let html = `
    <div class="resumoBox">
      <h2>Resumo do Romaneio</h2>
      <b>Empresa:</b> ${empresa.nome}<br>
      <b>CNPJ:</b> ${empresa.cnpj}<br><br>

      <h3>Itens:</h3>
      <ul>
  `;

  lista.forEach(i=>{
    html += `<li>${i.itemTR} — ${i.quant} × R$ ${i.valorUnit} = R$ ${i.total.toFixed(2)}</li>`;
  });

  html += `
      </ul>
      <h3>Total: R$ ${lista.reduce((s,i)=>s+i.total,0).toFixed(2)}</h3>

      <button class="btnConfirmar" onclick="enviarRomaneio()">Confirmar e Registrar</button>
      <button onclick="cancelarResumo()" style="margin-top:10px;background:#666;color:white">Voltar</button>
    </div>
  `;

  document.getElementById("resumo").innerHTML = html;
  document.getElementById("resumo").classList.remove("hidden");
}

/* VOLTAR */
function cancelarResumo(){
  document.getElementById("resumo").classList.add("hidden");
}

/* ============================
   5 — ENVIAR AO GAS
============================ */
async function enviarRomaneio(){

  let payload = {
    codigoLicitacao: document.getElementById("codigoLicitacao").value,
    empresa: empresa.nome,
    cnpj: empresa.cnpj,
    fornecedor: document.getElementById("fornecedor").value,
    contaBancaria: document.getElementById("conta").value,
    data: new Date().toISOString().split("T")[0],
    dataPrevista: document.getElementById("dataPrevista").value,
    itens: itens.filter(i=>i.quant>0)
  };

  let url = `${API}?action=registrarRomaneio&data=${encodeURIComponent(JSON.stringify(payload))}`;

  let resp = await fetch(url).then(r=>r.json());

  if(resp.ok){
    alert("Romaneio registrado com sucesso!");
    location.reload();
  } else {
    alert("Erro ao registrar.");
  }
}

</script>

</body>
</html>
