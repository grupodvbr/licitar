<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Gerar Romaneio • LICITAR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --azul:#0b1e39;
  --azul-claro:#15345c;
  --dourado:#c9a86c;
  --bg:#eef2f7;
  --card:#ffffff;
  --radius:18px;
  --shadow:0 10px 25px rgba(0,0,0,.12);
}

body{
  font-family:'Inter',sans-serif;
  background:var(--bg);
  margin:0;
  padding:20px;
}

/* CABEÇALHO */
h1{
  text-align:center;
  font-size:26px;
  color:var(--azul);
  margin-bottom:20px;
}

/* CARD */
.card{
  background:var(--card);
  padding:20px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  max-width:900px;
  margin:20px auto;
}

/* INPUTS */
input,select{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid #ccc;
  margin-bottom:12px;
  font-size:15px;
}

button{
  width:100%;
  padding:15px;
  background:var(--azul);
  border:none;
  border-radius:12px;
  color:white;
  font-size:17px;
  font-weight:600;
  cursor:pointer;
}
button:hover{
  background:var(--azul-claro);
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}
th,td{
  padding:10px;
  border-bottom:1px solid #ddd;
  font-size:14px;
}
th{
  background:var(--azul);
  color:white;
}

/* BOTÃO RESUMO */
.btn-dourado{
  background:var(--dourado);
  color:#000;
  font-weight:700;
}
.btn-dourado:hover{
  background:#b89554;
}

/* POPUP */
.overlay{
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,.55);
  display:none;
  justify-content:center;
  align-items:center;
  padding:20px;
}
.popup{
  background:white;
  max-width:420px;
  width:100%;
  padding:20px;
  border-radius:16px;
  box-shadow:var(--shadow);
}
.popup h2{
  margin-top:0;
  color:var(--azul);
}
.close{
  text-align:center;
  margin-top:20px;
}
.close button{
  background:#444;
}

/* TOTAL */
.total-final{
  margin-top:20px;
  font-size:20px;
  text-align:right;
  color:var(--azul);
  font-weight:700;
}

</style>
</head>

<body>

<h1>Gerar Romaneio</h1>

<div class="card">
  <label><b>Digite o código da licitação:</b></label>
  <input id="codigo" placeholder="Ex: LIC-0001">
  <button onclick="buscar()">Buscar Empresa e Itens</button>
</div>

<div id="dadosEmpresa" class="card" style="display:none;"></div>

<div id="listaItens" class="card" style="display:none;"></div>

<div class="card" id="controles" style="display:none;">
  <label><b>Fornecedor:</b></label>
  <select id="fornecedor"></select>

  <label><b>Conta Bancária:</b></label>
  <select id="conta"></select>

  <label><b>Data Prevista de Recebimento:</b></label>
  <input type="date" id="dataPrevista">

  <button class="btn-dourado" onclick="abrirResumo()">Ver Resumo e Confirmar</button>
</div>

<!-- POPUP RESUMO -->
<div id="popResumo" class="overlay">
  <div class="popup">
    <h2>Resumo do Romaneio</h2>
    <div id="conteudoResumo"></div>

    <div class="close">
      <button onclick="enviarRomaneio()">Confirmar Romaneio</button>
      <button onclick="fecharResumo()">Fechar</button>
    </div>
  </div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbwq4Tl0h_2BjnawrERxl546y1GKf0H0yt9HnwDHROcmANHeV393V3WeR95zUeC6MrXg/exec"; // Cole aqui o URL do GAS publicado

let itensGlobal = [];
let empresaGlobal = {};
let codigoAtual = "";

/* ===============================
   BUSCAR EMPRESA + ITENS
================================ */
async function buscar(){
  codigoAtual = document.getElementById("codigo").value.trim();
  if(!codigoAtual) return alert("Digite o código da licitação.");

  let emp = await fetch(`${API}?action=getEmpresa&codigo=${codigoAtual}`).then(r=>r.json());
  if(emp.erro){
    alert("Licitação não encontrada.");
    return;
  }
  empresaGlobal = emp;

  document.getElementById("dadosEmpresa").style.display = "block";
  document.getElementById("dadosEmpresa").innerHTML = `
    <h3>Empresa / Instituição</h3>
    <p><b>Nome:</b> ${emp.nome}</p>
    <p><b>CNPJ:</b> ${emp.cnpj}</p>
    <p><b>UF:</b> ${emp.uf}</p>
  `;

  // ITENS
  itensGlobal = await fetch(`${API}?action=getItens&codigo=${codigoAtual}`).then(r=>r.json());

  montarTabelaItens();
  carregarFornecedores();
  carregarContas();
  document.getElementById("controles").style.display = "block";
}

/* ===============================
   LISTA DE ITENS
================================ */
function montarTabelaItens(){
  document.getElementById("listaItens").style.display = "block";

  let html = `
    <h3>Itens da Licitação</h3>
    <table>
      <tr>
        <th>Descrição</th>
        <th>Valor Unit.</th>
        <th>Qtd</th>
        <th>Total</th>
      </tr>
  `;

  itensGlobal.forEach((item, i)=>{
    html += `
      <tr>
        <td>${item.especificacao}</td>
        <td>R$ ${parseFloat(item.valorUnit).toFixed(2)}</td>
        <td><input type="number" min="0" value="0" id="q_${i}" oninput="calc(${i})"></td>
        <td id="t_${i}">R$ 0,00</td>
      </tr>
    `;
  });

  html += `</table>`;

  html += `<div class="total-final">Total: <span id="totalGeral">R$ 0,00</span></div>`;

  document.getElementById("listaItens").innerHTML = html;
}

function calc(i){
  let qtd = Number(document.getElementById(`q_${i}`).value);
  let v = Number(itensGlobal[i].valorUnit);
  let tot = qtd * v;

  document.getElementById(`t_${i}`).innerHTML = "R$ " + tot.toFixed(2);

  somarTotal();
}

function somarTotal(){
  let total = 0;
  itensGlobal.forEach((item,i)=>{
    let qtd = Number(document.getElementById(`q_${i}`).value);
    total += qtd * Number(item.valorUnit);
  });
  document.getElementById("totalGeral").innerHTML = "R$ " + total.toFixed(2);
}

/* ===============================
   FORNECEDORES + CONTAS
================================ */
async function carregarFornecedores(){
  let lista = await fetch(`${API}?action=getFornecedores`).then(r=>r.json());
  let html = `<option value="">Selecione...</option>`;
  lista.forEach(f=>{
    html += `<option>${f.nome}</option>`;
  });
  document.getElementById("fornecedor").innerHTML = html;
}

async function carregarContas(){
  let lista = await fetch(`${API}?action=getContas`).then(r=>r.json());
  let html = `<option value="">Selecione...</option>`;
  lista.forEach(c=>{
    html += `<option>${c.banco} – Ag ${c.agencia} – Cc ${c.conta}</option>`;
  });
  document.getElementById("conta").innerHTML = html;
}

/* ===============================
   RESUMO DO ROMANEIO
================================ */
function abrirResumo(){
  let fornecedor = document.getElementById("fornecedor").value;
  let conta = document.getElementById("conta").value;
  let dataPrev = document.getElementById("dataPrevista").value;

  if(!fornecedor || !conta || !dataPrev){
    alert("Preencha fornecedor, conta e data prevista.");
    return;
  }

  let resumo = `<p><b>Empresa:</b> ${empresaGlobal.nome}</p>`;
  resumo += `<p><b>CNPJ:</b> ${empresaGlobal.cnpj}</p>`;
  resumo += `<p><b>Fornecedor:</b> ${fornecedor}</p>`;
  resumo += `<p><b>Conta:</b> ${conta}</p>`;
  resumo += `<p><b>Data Prevista:</b> ${dataPrev}</p><hr>`;

  resumo += `<h4>Itens Selecionados</h4><ul>`;
  itensGlobal.forEach((item,i)=>{
    let qtd = Number(document.getElementById(`q_${i}`).value);
    if(qtd > 0){
      resumo += `<li>${item.especificacao} — ${qtd} × R$ ${item.valorUnit} = R$ ${(qtd*item.valorUnit).toFixed(2)}</li>`;
    }
  });
  resumo += `</ul><hr>`;

  resumo += `<h3>Total Geral: ${document.getElementById("totalGeral").innerText}</h3>`;

  document.getElementById("conteudoResumo").innerHTML = resumo;
  document.getElementById("popResumo").style.display = "flex";
}

function fecharResumo(){
  document.getElementById("popResumo").style.display = "none";
}

/* ===============================
   ENVIAR PARA O GAS
================================ */
async function enviarRomaneio(){
  let fornecedor = document.getElementById("fornecedor").value;
  let conta = document.getElementById("conta").value;
  let dataPrev = document.getElementById("dataPrevista").value;

  let itensEnvio = [];

  itensGlobal.forEach((item,i)=>{
    let qtd = Number(document.getElementById(`q_${i}`).value);
    if(qtd > 0){
      itensEnvio.push({
        itemTR:item.itemTR,
        descricao:item.especificacao,
        qtd:qtd,
        valorUnit:Number(item.valorUnit),
        total:qtd * Number(item.valorUnit)
      });
    }
  });

  let payload = {
    codigoLicitacao: codigoAtual,
    empresa: empresaGlobal.nome,
    cnpj: empresaGlobal.cnpj,
    fornecedor,
    contaBancaria:conta,
    data: new Date().toISOString().split("T")[0],
    dataPrevista:dataPrev,
    itens:itensEnvio
  };

  const res = await fetch(`${API}?action=registrarRomaneio&data=${encodeURIComponent(JSON.stringify(payload))}`)
    .then(r=>r.json());

  if(res.ok){
    alert("Romaneio registrado com sucesso!");
    fecharResumo();
  } else {
    alert("Erro ao registrar romaneio.");
  }
}
</script>

</body>
</html>
