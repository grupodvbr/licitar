<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Romaneios • LICITAR</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
  --azul:#0b1e39;
  --azul-claro:#15345c;
  --dourado:#c9a86c;
  --bg:#eef2f7;
  --card:#ffffff;
  --radius:20px;
  --shadow:0 12px 30px rgba(0,0,0,.15);
  --shadow-sm:0 6px 18px rgba(0,0,0,.10);
}

body{
  margin:0;
  background:var(--bg);
  font-family:'Inter',sans-serif;
  color:#111;
}

/* HEADER */
header{
  background:var(--azul);
  color:white;
  text-align:center;
  padding:22px;
  font-size:26px;
  font-weight:800;
  letter-spacing:.5px;
  box-shadow:var(--shadow);
}

/* LOADING */
#overlay{
  position:fixed;
  inset:0;
  background:rgba(255,255,255,.8);
  backdrop-filter:blur(5px);
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:99999;
}
.spin{
  width:45px;
  height:45px;
  border:5px solid #cfd3d8;
  border-top-color:var(--azul);
  border-radius:50%;
  animation:spin 1s linear infinite;
}
@keyframes spin{ to{ transform:rotate(360deg);} }

/* CARDS */
.section{
  padding:24px;
}
.card{
  background:white;
  padding:20px;
  border-radius:var(--radius);
  box-shadow:var(--shadow-sm);
  margin-bottom:18px;
  cursor:pointer;
  transition:.2s;
}
.card:hover{
  transform:translateY(-5px);
  box-shadow:var(--shadow);
}
.card h3{
  margin:0;
  font-size:20px;
  font-weight:800;
  color:var(--azul);
}
.card small{
  display:block;
  margin-top:4px;
  color:#444;
}

/* POPUP */
#popup{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:9999;
}
.popupBox{
  background:white;
  padding:25px;
  width:90%;
  max-width:460px;
  border-radius:18px;
  box-shadow:var(--shadow);
  text-align:center;
}
.btn{
  background:var(--dourado);
  border:none;
  padding:10px 16px;
  border-radius:12px;
  cursor:pointer;
  font-weight:700;
  margin-top:12px;
  transition:.2s;
}
.btn:hover{ background:#b08b47; }

.selectList{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid #ccc;
  margin-top:12px;
  font-size:16px;
}
.copyBox{
  width:100%;
  padding:14px;
  border-radius:10px;
  border:1px solid #ccc;
  margin-top:15px;
}
</style>
</head>

<body>

<div id="overlay"><div class="spin"></div></div>

<header>Painel de Romaneios</header>

<div class="section">
  <h2 style="color:var(--azul);font-size:22px;">Empresas com Romaneios</h2>
  <div id="listaEmpresas"></div>
</div>

<!-- POPUP SELEÇÃO DO ROMANEIO -->
<div id="popup">
  <div class="popupBox" id="popupContent"></div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbz4bNXkwvJCsVAOG111baPF4qCLD-6F9rHt-tkGDLUWR9-cBMqSEzKfQlXCCgOaYHeK/exec";  // ALTERAR

let empresas = [];
let romaneios = [];

/* ======================== INIT ======================== */
async function init(){
  const r = await fetch(`${API}?action=listarRemessas`);
  romaneios = await r.json();

  montarEmpresas();
  overlay.style.display="none";
}
init();

/* ======================== LISTAGEM DE EMPRESAS ======================== */
function montarEmpresas(){

  const lista = {};

  romaneios.forEach(r => {
    if (!lista[r.empresa]) lista[r.empresa] = [];
    lista[r.empresa].push(r);
  });

  let html = "";

  Object.keys(lista).forEach(emp => {
    html += `
      <div class="card" onclick="abrirEmpresa('${emp}')">
        <h3>${emp}</h3>
        <small>${lista[emp].length} romaneio(s)</small>
      </div>
    `;
  });

  listaEmpresas.innerHTML = html || "<p style='color:#666'>Nenhuma empresa com romaneios.</p>";
}

/* ======================== POPUP DA EMPRESA ======================== */
async function abrirEmpresa(empresa){

  const fornecedores = await fetch(`${API}?action=getFornecedores`).then(r=>r.json());

  const meusR = romaneios.filter(r => r.empresa === empresa);

  let romOps = meusR.map(r =>
    `<option value="${r.romaneioID}">${r.romaneioID} — Total R$ ${Number(r.total).toLocaleString("pt-BR",{minimumFractionDigits:2})}</option>`
  ).join("");

  let fornOps = fornecedores.map(f =>
    `<option value="${f.codigo}">${f.nome} — ${f.cnpj}</option>`
  ).join("");

  popupContent.innerHTML = `
    <h3 style="color:var(--azul);">Gerar Cotação</h3>

    <label>Selecione o Romaneio:</label>
    <select id="romSel" class="selectList">${romOps}</select>

    <label style="margin-top:14px; display:block;">Selecione o Fornecedor:</label>
    <select id="fornSel" class="selectList">${fornOps}</select>

    <button class="btn" onclick="gerarLink()">Gerar Link</button>
    <button class="btn" style="background:#666;color:white" onclick="fechar()">Fechar</button>
  `;

  popup.style.display="flex";
}

/* ======================== GERAR LINK ======================== */
function gerarLink(){
  const rom = document.getElementById("romSel").value;
  const forn = document.getElementById("fornSel").value;

  const link = `${API}?action=fornecedorCotacao&romaneioID=${rom}&fornecedor=${forn}`;

  popupContent.innerHTML = `
    <h3 style="color:var(--azul);">Link Gerado</h3>
    <input class="copyBox" id="copy" readonly value="${link}">

    <button class="btn" onclick="copiar()">Copiar</button>
    <button class="btn" style="background:#666;color:white" onclick="fechar()">Fechar</button>
  `;
}

function copiar(){
  const c = document.getElementById("copy");
  c.select();
  document.execCommand("copy");
  alert("Copiado!");
}

function fechar(){
  popup.style.display="none";
}
</script>

</body>
</html>
